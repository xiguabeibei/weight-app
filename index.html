<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>甜心健身日记</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        
        body { 
            background: linear-gradient(135deg, #fff5f7 0%, #ffe4e9 100%);
            color: #d63384;
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
        }

        /* 可爱气泡背景 */
        .bubbles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .bubble { position: absolute; bottom: -20px; background: rgba(255, 182, 193, 0.4); border-radius: 50%; animation: rise 15s infinite ease-in; }
        @keyframes rise {
            0% { transform: translateY(0) scale(1); opacity: 0.5; }
            100% { transform: translateY(-100vh) scale(1.5); opacity: 0; }
        }

        .pink-card {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #ffdae0;
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            box-shadow: 0 8px 20px rgba(255, 182, 193, 0.2);
        }

        .btn-main { background: #ff758f; color: white; font-weight: 900; box-shadow: 0 4px 10px rgba(255, 117, 143, 0.3); }
        .sidebar-active { background: #ff758f; color: white !important; box-shadow: 0 4px 12px rgba(255, 117, 143, 0.3); }

        /* 滑动删除：修复重叠透明问题 */
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-x; border-radius: 1.2rem; margin-bottom: 0.75rem; background: #ff4d6d; }
        .swipe-content { position: relative; z-index: 20; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1); background: white; display: flex; align-items: center; width: 100%; }
        .delete-action { 
            position: absolute; right: 0; top: 0; bottom: 0; width: 80px;
            background: #ff4d6d; color: white; display: flex; align-items: center; 
            justify-content: center; z-index: 10; font-weight: 900;
        }

        .progress-fill { transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); }

        input, select, textarea {
            background: white !important;
            border: 2px solid #ffdae0 !important;
            border-radius: 1rem !important;
            color: #d63384 !important;
            outline: none;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen p-4 gap-4">

    <div class="bubbles" id="bubble-wrap"></div>

    <aside class="w-64 flex flex-col p-6 pink-card">
        <div class="flex items-center gap-3 mb-8 px-2">
            <div class="w-10 h-10 rounded-2xl btn-main flex items-center justify-center"><i data-lucide="heart"></i></div>
            <h1 class="font-900 text-xl tracking-tight">甜心日记</h1>
        </div>
        <nav id="user-nav" class="flex-1 space-y-2 overflow-y-auto no-scrollbar"></nav>
        <div class="pt-4 border-t border-pink-200 space-y-2">
            <button onclick="addUser()" class="w-full p-4 rounded-xl text-pink-400 hover:bg-pink-50 flex items-center gap-3 text-sm font-bold transition-all"><i data-lucide="plus-circle" class="w-4 h-4"></i> 新增成员</button>
            <button onclick="openManageModal()" class="w-full p-4 rounded-xl text-pink-400 hover:bg-pink-50 flex items-center gap-3 text-sm font-bold transition-all"><i data-lucide="settings" class="w-4 h-4"></i> 档案设置</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar space-y-6">
        
        <section class="pink-card p-6">
            <div class="flex justify-between items-end mb-3">
                <span class="text-xs font-900">减重进度</span>
                <span id="progress-text" class="text-sm font-black italic">0%</span>
            </div>
            <div class="w-full h-4 bg-pink-100 rounded-full overflow-hidden p-1 border border-pink-200">
                <div id="progress-bar" class="progress-fill h-full bg-gradient-to-r from-pink-300 to-pink-500 rounded-full w-0"></div>
            </div>
            <div class="flex justify-between mt-2 text-[10px] font-bold opacity-60 uppercase tracking-widest">
                <span>初始: <span id="start-w">--</span>kg</span>
                <span>目标: <span id="target-w">--</span>kg</span>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <section class="lg:col-span-2 pink-card p-8 min-h-[260px] flex flex-col justify-between relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-4 mb-2">
                            <h2 id="display-name" class="text-5xl font-900 tracking-tighter">--</h2>
                            <div id="display-gender-icon"></div>
                        </div>
                        <p id="display-wish" class="text-sm font-bold text-pink-400">正在努力加载中...</p>
                    </div>
                    <div class="text-right">
                        <span id="status-tag" class="text-6xl font-900">-.-</span>
                        <p class="text-[10px] font-black opacity-50 mt-1 italic">离目标还差 (KG)</p>
                    </div>
                </div>
                <div id="mood-display" class="mt-4 p-4 rounded-2xl bg-white/50 border border-pink-100 text-xs font-bold">心情状态: --</div>
            </section>

            <section class="pink-card p-8 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="font-900 text-sm flex items-center gap-2"><i data-lucide="sparkles" class="text-pink-400"></i> 我的好习惯</h4>
                    <button onclick="addInterest()" class="btn-main w-8 h-8 rounded-full flex items-center justify-center shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div id="interest-list" class="space-y-3 overflow-y-auto no-scrollbar flex-1"></div>
            </section>
        </div>

        <section class="pink-card p-8">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-sm font-900 flex items-center gap-2"><i data-lucide="trending-down"></i> 体重变化曲线</h3>
                <div class="flex gap-2 text-[10px] font-bold">
                    <input type="date" id="chart-start" onchange="renderChart()" class="p-1">
                    <input type="date" id="chart-end" onchange="renderChart()" class="p-1">
                </div>
            </div>
            <div class="h-64 w-full"><canvas id="weightChart"></canvas></div>
        </section>

        <section class="pink-card p-8">
            <div class="flex flex-wrap items-center justify-between gap-6 mb-8">
                <input type="date" id="global-date" onchange="render()" class="font-900 text-2xl text-pink-500">
                <div class="flex gap-1 p-1 bg-pink-100/50 rounded-2xl">
                    <button onclick="setLogType('weight')" id="tab-weight" class="px-6 py-2 rounded-xl font-900 text-xs transition-all">测体重</button>
                    <button onclick="setLogType('food')" id="tab-food" class="px-6 py-2 rounded-xl font-900 text-xs transition-all">吃东西</button>
                    <button onclick="setLogType('sport')" id="tab-sport" class="px-6 py-2 rounded-xl font-900 text-xs transition-all">做运动</button>
                </div>
            </div>
            <div id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-20">
            <div id="list-food"></div>
            <div id="list-sport"></div>
        </div>
    </main>

    <div id="manage-modal" class="hidden fixed inset-0 bg-pink-900/20 backdrop-blur-md z-50 flex items-center justify-center p-6">
        <div class="pink-card p-10 w-full max-w-2xl border-white bg-white/90 shadow-2xl">
            <h2 class="text-2xl font-900 mb-8 flex items-center gap-3"><i data-lucide="user"></i> 个人档案设置</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-1"><label class="text-xs font-bold opacity-60 ml-2">姓名</label><input type="text" id="m-name" class="w-full p-4 font-bold"></div>
                <div class="space-y-1"><label class="text-xs font-bold opacity-60 ml-2">性别</label><select id="m-gender" class="w-full p-4 font-bold"><option value="female">女生</option><option value="male">男生</option></select></div>
                <div class="space-y-1"><label class="text-xs font-bold opacity-60 ml-2">目标体重 (KG)</label><input type="number" id="m-target" class="w-full p-4 font-bold"></div>
                <div class="space-y-1"><label class="text-xs font-bold opacity-60 ml-2">减重愿望</label><input type="text" id="m-wish" class="w-full p-4 font-bold"></div>
                <div class="space-y-1 md:col-span-2"><label class="text-xs font-bold opacity-60 ml-2">今日寄语</label><textarea id="m-mood" class="w-full p-4 font-bold h-24"></textarea></div>
            </div>
            <div class="flex gap-4 mt-10">
                <button onclick="closeManageModal()" class="flex-1 font-black opacity-40">返回</button>
                <button onclick="saveUserManage()" class="flex-1 p-5 btn-main rounded-2xl shadow-lg shadow-pink-200">保存更新</button>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('sf_cute_v1') || '[]');
        let curUid = localStorage.getItem('sf_cute_uid') || (users[0]?.id || null);
        let entryType = 'weight', chart = null;

        // 背景气泡生成
        function createBubbles() {
            const wrap = document.getElementById('bubble-wrap');
            for(let i=0; i<15; i++) {
                const b = document.createElement('div');
                b.className = 'bubble';
                const size = Math.random() * 60 + 20 + 'px';
                b.style.width = size; b.style.height = size;
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDelay = Math.random() * 10 + 's';
                b.style.animationDuration = Math.random() * 10 + 10 + 's';
                wrap.appendChild(b);
            }
        }

        // 滑动删除交互修复
        let tStart = 0, currentSwipeEl = null;
        document.addEventListener('touchstart', e => {
            const container = e.target.closest('.swipe-container');
            if (container) {
                document.querySelectorAll('.swipe-content').forEach(el => { if(el !== container.querySelector('.swipe-content')) el.style.transform = 'translateX(0)'; });
                tStart = e.touches[0].clientX;
                currentSwipeEl = container.querySelector('.swipe-content');
                currentSwipeEl.style.transition = 'none';
            }
        }, {passive: true});

        document.addEventListener('touchmove', e => {
            if (!currentSwipeEl) return;
            const diff = e.touches[0].clientX - tStart;
            if (diff < 0) currentSwipeEl.style.transform = `translateX(${Math.max(diff, -80)}px)`;
            if (diff > 0) currentSwipeEl.style.transform = `translateX(0)`;
        }, {passive: true});

        document.addEventListener('touchend', e => {
            if (!currentSwipeEl) return;
            currentSwipeEl.style.transition = 'transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1)';
            const diff = e.changedTouches[0].clientX - tStart;
            currentSwipeEl.style.transform = diff < -40 ? `translateX(-80px)` : `translateX(0)`;
            currentSwipeEl = null;
        });

        function sync() {
            localStorage.setItem('sf_cute_v1', JSON.stringify(users));
            if(curUid) localStorage.setItem('sf_cute_uid', curUid);
            render();
        }

        function addUser() {
            const name = prompt("输入新成员的昵称:"); if(!name) return;
            const u = { id: Date.now(), name, target: 50, gender: 'female', weights: [], logs: [], interests: [] };
            users.push(u); curUid = u.id; sync();
        }

        function deleteItem(id, listType) {
            const u = users.find(x => x.id == curUid);
            if(listType === 'interest') u.interests = u.interests.filter(i => i.id !== id);
            else if(listType === 'user') { users = users.filter(u => u.id !== id); curUid = users[0]?.id || null; }
            else u.logs = u.logs.filter(l => l.id !== id);
            sync();
        }

        function toggleInterest(id) {
            const u = users.find(x => x.id == curUid);
            const i = u.interests.find(x => x.id === id);
            i.paused = !i.paused;
            sync();
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const date = document.getElementById('global-date').value;
            const slot = document.getElementById('e-slot').value;

            if (entryType === 'weight') {
                const val = parseFloat(document.getElementById('e-val').value);
                if (!val) return;
                const idx = u.weights.findIndex(w => w.date === date && w.slot === slot);
                if (idx > -1) {
                    if (confirm(`记录已存在，要更新为 ${val}kg 吗？`)) u.weights[idx].val = val;
                } else {
                    u.weights.push({ id: Date.now(), val, slot, date, ts: new Date(date).getTime() });
                }
            } else {
                const name = document.getElementById('e-name').value, cal = parseInt(document.getElementById('e-cal').value);
                if (!name || isNaN(cal)) return;
                const idx = u.logs.findIndex(l => l.date === date && l.name === name && l.type === entryType);
                if (idx > -1) {
                    if (confirm(`今日已记录过 "${name}"，要更新卡路里吗？`)) u.logs[idx].cal = cal;
                } else {
                    u.logs.unshift({ id: Date.now(), type: entryType, name, cal, slot, date });
                }
            }
            sync();
        }

        function render() {
            // 用户导航
            document.getElementById('user-nav').innerHTML = users.map(u => `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${u.id}, 'user')">删除</div>
                    <div onclick="curUid=${u.id};sync()" class="swipe-content p-4 cursor-pointer ${curUid == u.id ? 'sidebar-active text-white' : 'text-pink-400 hover:bg-pink-50'}">
                        <span class="font-black text-sm flex-1">${u.name}</span>
                        <i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-3 h-3 opacity-50"></i>
                    </div>
                </div>`).join('');
            
            const u = users.find(x => x.id == curUid); 
            if(!u) return;

            // 顶部进度条逻辑
            const sortedWeights = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const startW = sortedWeights.length > 0 ? sortedWeights[0].val : u.target + 10;
            const curW = sortedWeights.length > 0 ? sortedWeights[sortedWeights.length-1].val : startW;
            const targetW = u.target;
            
            let progress = 0;
            if(startW > targetW) {
                progress = Math.max(0, Math.min(100, ((startW - curW) / (startW - targetW)) * 100));
            } else {
                progress = curW <= targetW ? 100 : 0;
            }

            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').innerText = Math.round(progress) + '%';
            document.getElementById('start-w').innerText = startW;
            document.getElementById('target-w').innerText = targetW;

            // 基础信息
            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-wish').innerText = u.wish || '快去写下你的减重愿望吧~';
            document.getElementById('mood-display').innerText = `今日寄语: ${u.mood || '保持可爱，保持健康'}`;
            document.getElementById('display-gender-icon').innerHTML = `<i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-8 h-8 ${u.gender==='male'?'text-blue-400':'text-pink-400'}"></i>`;
            
            const diff = (curW - targetW).toFixed(1);
            document.getElementById('status-tag').innerText = (diff > 0 ? "+" : "") + diff;

            // 兴趣列表
            document.getElementById('interest-list').innerHTML = (u.interests || []).map(i => {
                const days = Math.floor((Date.now() - i.start) / 86400000) + 1;
                return `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${i.id}, 'interest')">删除</div>
                    <div class="swipe-content p-4 border border-pink-100 flex flex-col items-stretch">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-black ${i.paused ? 'opacity-40' : ''}">${i.name}</span>
                            <button onclick="toggleInterest(${i.id})" class="text-pink-400">
                                <i data-lucide="${i.paused ? 'play' : 'pause'}" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="text-[9px] font-bold opacity-40 uppercase">已坚持 ${days} 天 ${i.paused ? '(已暂停)' : ''}</div>
                    </div>
                </div>`;
            }).join('');

            // 流水
            const gDate = document.getElementById('global-date').value;
            const logs = u.logs.filter(l => l.date === gDate);
            const logTpl = (l) => `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${l.id}, 'log')">删除</div>
                    <div class="swipe-content p-4 border border-pink-50 flex justify-between items-center">
                        <div>
                            <div class="font-black text-sm">${l.name}</div>
                            <div class="text-[9px] opacity-40 font-bold">${l.slot}</div>
                        </div>
                        <div class="text-right text-pink-500 font-black">${l.cal} 千卡</div>
                    </div>
                </div>`;
            
            document.getElementById('list-food').innerHTML = `<h4 class="text-xs font-black text-pink-400 px-2 mb-3">饮食摄入 >></h4>` + logs.filter(l=>l.type==='food').map(logTpl).join('');
            document.getElementById('list-sport').innerHTML = `<h4 class="text-xs font-black text-blue-400 px-2 mb-3">运动消耗 >></h4>` + logs.filter(l=>l.type==='sport').map(logTpl).join('');

            renderEntryForm(); renderChart(); lucide.createIcons();
        }

        function setLogType(t) { entryType = t; renderEntryForm(); }
        function renderEntryForm() {
            const container = document.getElementById('entry-form');
            ['weight', 'food', 'sport'].forEach(t => {
                const btn = document.getElementById('tab-'+t);
                btn.className = entryType === t ? "px-6 py-2 rounded-xl font-900 text-xs bg-pink-500 text-white shadow-lg" : "px-6 py-2 rounded-xl font-900 text-xs text-pink-300";
            });

            if(entryType === 'weight') {
                container.innerHTML = `<select id="e-slot" class="p-4 font-bold text-xs"><option value="晨间">晨间</option><option value="晚间">晚间</option></select><input type="number" id="e-val" step="0.1" placeholder="体重(KG)" class="p-4 font-bold md:col-span-2 text-xs"><button onclick="submitEntry()" class="btn-main p-4 rounded-xl text-xs">记录</button>`;
            } else {
                const slots = entryType === 'food' ? ["早餐","午餐","晚餐","加餐"] : ["有氧","无氧","拉伸"];
                container.innerHTML = `<select id="e-slot" class="p-4 font-bold text-xs">${slots.map(s=>`<option value="${s}">${s}</option>`).join('')}</select><input type="text" id="e-name" placeholder="名称" class="p-4 font-bold text-xs"><input type="number" id="e-cal" placeholder="千卡" class="p-4 font-bold text-xs"><button onclick="submitEntry()" class="btn-main p-4 rounded-xl text-xs">添加</button>`;
            }
        }

        function renderChart() {
            const u = users.find(x => x.id == curUid); if(!u || !u.weights.length) return;
            const ctx = document.getElementById('weightChart').getContext('2d');
            if(chart) chart.destroy();
            const sorted = [...u.weights].sort((a,b)=>a.ts-b.ts);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(x => x.date.slice(5) + ' ' + x.slot),
                    datasets: [{ 
                        data: sorted.map(x=>x.val), 
                        borderColor: '#ff758f', 
                        borderWidth: 4, tension: 0.4, fill: true, pointRadius: 5, pointBackgroundColor: '#fff',
                        backgroundColor: 'rgba(255, 117, 143, 0.1)'
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { grid: { color: '#ffeeef' }, ticks: { color: '#ff758f', font: { weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#ff758f', font: { size: 9 } } }
                    }
                }
            });
        }

        function addInterest() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const name = prompt("想养成什么好习惯呢？");
            if(name) { u.interests.push({ id: Date.now(), name, start: Date.now(), paused: false }); sync(); }
        }

        function openManageModal() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            document.getElementById('m-name').value = u.name;
            document.getElementById('m-gender').value = u.gender;
            document.getElementById('m-target').value = u.target;
            document.getElementById('m-wish').value = u.wish || '';
            document.getElementById('m-mood').value = u.mood || '';
            document.getElementById('manage-modal').classList.remove('hidden');
        }
        function closeManageModal() { document.getElementById('manage-modal').classList.add('hidden'); }
        function saveUserManage() {
            const u = users.find(x => x.id == curUid);
            u.name = document.getElementById('m-name').value; 
            u.gender = document.getElementById('m-gender').value;
            u.target = parseFloat(document.getElementById('m-target').value);
            u.wish = document.getElementById('m-wish').value; 
            u.mood = document.getElementById('m-mood').value;
            closeManageModal(); sync();
        }

        window.onload = () => { createBubbles(); sync(); };
    </script>
</body>
</html>      
