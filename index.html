<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çŒ«çŒ«å¥åº·">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3567/3567440.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3567/3567440.png">

    <title>å…¨åŠŸèƒ½å¥åº·æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;900&display=swap');
        body { background: linear-gradient(-45deg, #fff0f3, #e7f5ff, #f3f0ff, #fff9db); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #444; font-family: 'Noto Sans SC', sans-serif; height: 100vh; width: 100vw; overflow: hidden; }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
        .cat-bg { position: fixed; top: -10%; z-index: -1; pointer-events: none; animation: catFall linear infinite; font-size: 24px; }
        @keyframes catFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        .floating-card { background: rgba(255, 255, 255, 0.85); border: 4px solid white; backdrop-filter: blur(15px); border-radius: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-x; border-radius: 1.2rem; margin-bottom: 0.8rem; background: #ff6b6b !important; }
        .swipe-content { position: relative; z-index: 20; transition: transform 0.4s; background: white !important; width: 100%; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 60px; color: white; display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 12px; font-weight: 900; }
        #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-hidden { transform: translateX(-100%); width: 0 !important; padding: 0 !important; margin: 0 !important; opacity: 0; }
        .sidebar-active { background: #444 !important; color: white !important; }
        .text-pop { font-family: 'ZCOOL KuaiLe', cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .clickable:active { transform: scale(0.98); opacity: 0.8; }
    </style>
</head>
<body class="flex h-screen p-3 gap-4">
    <div id="cat-container"></div>

    <aside id="sidebar" class="w-64 flex flex-col p-5 floating-card shrink-0">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-pop text-xl text-orange-500">çŒ«çŒ«æ—¥è®°</h1>
            <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-xl"><i data-lucide="menu"></i></button>
        </div>
        <nav id="user-nav" class="flex-1 space-y-2 overflow-y-auto no-scrollbar"></nav>
        <div class="pt-4 border-t-2 border-dashed border-gray-100">
            <button onclick="addUser()" class="w-full p-3 rounded-xl bg-green-400 text-white font-black text-sm shadow-md mb-2">æ·»åŠ æˆå‘˜</button>
            <button onclick="openManageModal()" class="w-full p-3 rounded-xl text-gray-400 font-bold text-xs hover:bg-gray-50">æˆå‘˜æ¡£æ¡ˆ</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-10">
        <div class="flex items-center gap-4">
            <button id="sidebar-trigger" onclick="toggleSidebar()" class="hidden p-3 floating-card text-orange-500"><i data-lucide="menu"></i></button>
            <div class="flex-1 floating-card p-4 flex items-center justify-between">
                <input type="date" id="global-date" onchange="render()" class="font-black text-orange-600 bg-transparent border-none focus:ring-0">
                <div id="progress-percent" class="bg-blue-500 text-white px-3 py-1 rounded-full text-[10px] font-black italic">PROGRESS: 0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <section class="lg:col-span-2 floating-card border-[#baffc9] p-8 relative">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-4 mb-3">
                            <h2 id="display-name" class="text-pop text-5xl text-green-600">--</h2>
                            <div id="display-gender-icon"></div>
                        </div>
                        <div onclick="editWish()" class="clickable inline-block bg-green-500 text-white px-4 py-1.5 rounded-xl text-xs font-black shadow-lg cursor-pointer">
                            ğŸŒŸ æ„¿æœ›ï¼š<span id="display-wish">ç‚¹å‡»è®¾ç½®æ„¿æœ›</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="status-tag" class="text-6xl text-pop text-green-500">0.0</div>
                        <p class="text-[10px] font-black opacity-30 mt-1 italic">KG TO GO</p>
                    </div>
                </div>
                <div onclick="editMood()" class="clickable mt-6 p-4 rounded-2xl bg-white/60 border-2 border-dashed border-green-200 text-sm font-bold italic text-green-700 cursor-pointer">
                    ğŸ± å½“å‰çŠ¶æ€: <span id="mood-display">ç‚¹å‡»è®°å½•å¿ƒæƒ…...</span>
                </div>
            </section>

            <section class="floating-card border-[#decaff] p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-pop text-purple-500">ğŸ¨ å…´è¶£çˆ±å¥½</h4>
                    <button onclick="addInterest()" class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shadow-md"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div id="interest-list" class="space-y-3 overflow-y-auto no-scrollbar flex-1 max-h-48"></div>
            </section>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <section class="floating-card border-[#ffffba] p-6">
                <h3 class="text-pop text-sm text-yellow-600 mb-4">ä½“é‡æ›²çº¿</h3>
                <div class="h-48"><canvas id="weightChart"></canvas></div>
            </section>
            <section class="floating-card border-[#ffc9c9] p-6">
                <h3 class="text-pop text-sm text-red-500 mb-4">è¡€å‹åŒæ›²çº¿</h3>
                <div class="h-48"><canvas id="bpChart"></canvas></div>
            </section>
        </div>

        <section class="floating-card border-[#ffdfba] p-6">
            <div class="flex gap-2 p-1 bg-orange-50 rounded-2xl mb-6 w-fit">
                <button onclick="setLogType('weight')" id="tab-weight" class="px-5 py-2 rounded-xl font-black text-[10px] transition-all">ä½“é‡</button>
                <button onclick="setLogType('bp')" id="tab-bp" class="px-5 py-2 rounded-xl font-black text-[10px] transition-all">è¡€å‹</button>
                <button onclick="setLogType('food')" id="tab-food" class="px-5 py-2 rounded-xl font-black text-[10px] transition-all">è¡¥ç»™</button>
                <button onclick="setLogType('sport')" id="tab-sport" class="px-5 py-2 rounded-xl font-black text-[10px] transition-all">æ¶ˆè€—</button>
            </div>
            <div id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
            <div id="list-food"></div>
            <div id="list-sport"></div>
        </div>
    </main>

    <div id="manage-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-xl z-50 flex items-center justify-center p-6">
        <div class="floating-card p-10 w-full max-w-md bg-white">
            <h2 class="text-pop text-2xl mb-6">ä¿®æ”¹æ¡£æ¡ˆ</h2>
            <div class="space-y-4">
                <input type="text" id="m-name" placeholder="åç§°" class="w-full p-4 rounded-xl bg-gray-50 border-none">
                <select id="m-gender" class="w-full p-4 rounded-xl bg-gray-50 border-none"><option value="female">å¥³ç”Ÿ</option><option value="male">ç”·ç”Ÿ</option></select>
                <input type="number" id="m-target" placeholder="ç›®æ ‡ä½“é‡" class="w-full p-4 rounded-xl bg-gray-50 border-none">
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeManageModal()" class="flex-1 font-bold text-gray-400">å–æ¶ˆ</button>
                <button onclick="saveUserManage()" class="flex-1 p-4 bg-gray-800 text-white rounded-xl font-black">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('sf_colorful_v4') || '[]');
        let curUid = localStorage.getItem('sf_colorful_uid') || (users[0]?.id || null);
        let entryType = 'weight', charts = {};

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const trigger = document.getElementById('sidebar-trigger');
            sb.classList.toggle('sidebar-hidden');
            trigger.classList.toggle('hidden', !sb.classList.contains('sidebar-hidden'));
        }

        function createCat() {
            const container = document.getElementById('cat-container');
            const cat = document.createElement('div');
            cat.className = 'cat-bg';
            cat.style.left = Math.random() * 100 + 'vw';
            cat.innerText = ['ğŸ±', 'ğŸˆ', 'ğŸ¾', 'ğŸ˜»'][Math.floor(Math.random()*4)];
            cat.style.animationDuration = Math.random() * 5 + 8 + 's';
            container.appendChild(cat);
            setTimeout(() => cat.remove(), 12000);
        }
        setInterval(createCat, 1500);

        function sync() {
            localStorage.setItem('sf_colorful_v4', JSON.stringify(users));
            if(curUid) localStorage.setItem('sf_colorful_uid', curUid);
            render();
        }

        function editWish() {
            const u = users.find(x => x.id == curUid);
            const w = prompt("ä½ çš„æ–°æ„¿æœ›æ˜¯ï¼Ÿ", u.wish || "");
            if(w !== null) { u.wish = w; sync(); }
        }

        function editMood() {
            const u = users.find(x => x.id == curUid);
            const m = prompt("ç°åœ¨çš„çŠ¶æ€/å¿ƒæƒ…å¦‚ä½•ï¼Ÿ", u.mood || "");
            if(m !== null) { u.mood = m; sync(); }
        }

        function toggleInterest(id) {
            const u = users.find(x => x.id == curUid);
            const i = u.interests.find(it => it.id === id);
            i.paused = !i.paused;
            sync();
        }

        function addInterest() {
            const name = prompt("æƒ³åŸ¹å…»ä»€ä¹ˆå…´è¶£ï¼Ÿ");
            if(name) {
                const u = users.find(x => x.id == curUid);
                u.interests.push({ id: Date.now(), name, start: Date.now(), paused: false });
                sync();
            }
        }

        function render() {
            const uNav = document.getElementById('user-nav');
            uNav.innerHTML = users.map(u => `<div onclick="curUid=${u.id};sync()" class="p-4 cursor-pointer rounded-2xl font-bold transition-all ${curUid == u.id ? 'sidebar-active shadow-lg' : 'text-gray-400'}">${u.name}</div>`).join('');
            
            const u = users.find(x => x.id == curUid); if(!u) return;

            // çŠ¶æ€æ¸²æŸ“
            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-wish').innerText = u.wish || 'ç‚¹å‡»è®¾ç½®';
            document.getElementById('mood-display').innerText = u.mood || 'ç‚¹å‡»è®°å½•çŠ¶æ€...';
            document.getElementById('display-gender-icon').innerHTML = `<i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-8 h-8 ${u.gender==='male'?'text-blue-400':'text-pink-400'}"></i>`;

            // å…´è¶£åˆ—è¡¨
            document.getElementById('interest-list').innerHTML = (u.interests || []).map(i => {
                const days = Math.floor((Date.now() - i.start) / 86400000) + 1;
                return `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${i.id}, 'interest')">åˆ é™¤</div>
                    <div class="swipe-content p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleInterest(${i.id})" class="w-8 h-8 rounded-full flex items-center justify-center ${i.paused ? 'bg-gray-100 text-gray-400' : 'bg-purple-100 text-purple-600 animate-pulse'}">
                                <i data-lucide="${i.paused ? 'play' : 'pause'}" class="w-4 h-4"></i>
                            </button>
                            <div>
                                <div class="text-xs font-black ${i.paused ? 'text-gray-400 line-through' : 'text-purple-700'}">${i.name}</div>
                                <div class="text-[9px] opacity-40 italic">å·²åšæŒ ${days} å¤©</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // ä½“é‡è¿›åº¦
            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const curW = sortedW.length ? sortedW[sortedW.length-1].val : u.target;
            const diff = (curW - u.target).toFixed(1);
            document.getElementById('status-tag').innerText = (diff > 0 ? "+" : "") + diff;
            const progress = sortedW.length ? Math.min(100, Math.max(0, (sortedW[0].val - curW) / (sortedW[0].val - u.target) * 100)) : 0;
            document.getElementById('progress-percent').innerText = `PROGRESS: ${Math.round(progress)}%`;

            // è¡¥ç»™/è¿åŠ¨
            const gDate = document.getElementById('global-date').value;
            const logs = u.logs.filter(l => l.date === gDate);
            const logTpl = (l, color) => `<div class="swipe-container"><div class="delete-action" onclick="deleteItem(${l.id}, 'log')">åˆ é™¤</div><div class="swipe-content p-3 border-2 border-${color}-50 flex justify-between items-center"><div class="text-xs font-black">${l.name}</div><div class="text-xs font-black text-${color}-500">${l.cal}</div></div></div>`;
            document.getElementById('list-food').innerHTML = `<h4 class="text-pop text-orange-500 text-xs mb-2">ğŸ­ è¡¥ç»™</h4>` + logs.filter(l=>l.type==='food').map(l=>logTpl(l, 'orange')).join('');
            document.getElementById('list-sport').innerHTML = `<h4 class="text-pop text-blue-500 text-xs mb-2">ğŸ”¥ æ¶ˆè€—</h4>` + logs.filter(l=>l.type==='sport').map(l=>logTpl(l, 'blue')).join('');

            updateCharts(u); renderEntryForm(); lucide.createIcons();
        }

        function updateCharts(u) {
            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const sortedBP = [...u.bps].sort((a,b)=>a.ts-b.ts);
            if(charts.w) charts.w.destroy();
            charts.w = new Chart(document.getElementById('weightChart').getContext('2d'), { type: 'line', data: { labels: sortedW.map(w=>w.date.slice(5)), datasets: [{ data: sortedW.map(w=>w.val), borderColor: '#fcc419', tension: 0.4, fill: true, backgroundColor: 'rgba(252,196,25,0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            if(charts.bp) charts.bp.destroy();
            charts.bp = new Chart(document.getElementById('bpChart').getContext('2d'), { type: 'line', data: { labels: sortedBP.map(b=>b.date.slice(5)), datasets: [{ label: 'é«˜å‹', data: sortedBP.map(b=>b.high), borderColor: '#ff6b6b', tension: 0.4 }, { label: 'ä½å‹', data: sortedBP.map(b=>b.low), borderColor: '#4dabf7', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function setLogType(t) { entryType = t; renderEntryForm(); }
        function renderEntryForm() {
            const container = document.getElementById('entry-form');
            ['weight', 'bp', 'food', 'sport'].forEach(t => document.getElementById('tab-'+t).className = entryType === t ? 'px-5 py-2 rounded-xl font-black text-[10px] bg-orange-500 text-white shadow-md' : 'px-5 py-2 rounded-xl font-black text-[10px] text-orange-300');
            if(entryType === 'weight') container.innerHTML = `<select id="e-slot" class="p-3 rounded-xl border-none shadow-inner text-xs"><option value="æ™¨é—´">æ—©æ™¨</option><option value="æ™šé—´">ç¡å‰</option></select><input type="number" id="e-val" placeholder="ä½“é‡(KG)" class="p-3 rounded-xl border-none shadow-inner text-xs md:col-span-2"><button onclick="submitEntry()" class="bg-orange-500 text-white rounded-xl font-black text-xs">è®°å½•</button>`;
            else if(entryType === 'bp') container.innerHTML = `<select id="e-slot" class="p-3 rounded-xl border-none shadow-inner text-xs"><option value="æ™¨é—´">æ—©æ™¨</option><option value="æ™šé—´">ç¡å‰</option></select><input type="number" id="e-high" placeholder="é«˜å‹" class="p-3 rounded-xl border-none shadow-inner text-xs"><input type="number" id="e-low" placeholder="ä½å‹" class="p-3 rounded-xl border-none shadow-inner text-xs"><button onclick="submitEntry()" class="bg-red-400 text-white rounded-xl font-black text-xs">è®°å½•</button>`;
            else container.innerHTML = `<select id="e-slot" class="p-3 rounded-xl border-none shadow-inner text-xs"><option value="åˆé¤">åˆé¤</option><option value="è¿åŠ¨">è¿åŠ¨</option></select><input type="text" id="e-name" placeholder="åç§°" class="p-3 rounded-xl border-none shadow-inner text-xs"><input type="number" id="e-cal" placeholder="KCAL" class="p-3 rounded-xl border-none shadow-inner text-xs"><button onclick="submitEntry()" class="bg-blue-400 text-white rounded-xl font-black text-xs">è®°å½•</button>`;
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const date = document.getElementById('global-date').value;
            const slot = document.getElementById('e-slot').value;
            if (entryType === 'weight') { const val = parseFloat(document.getElementById('e-val').value); if (val) u.weights.push({ id: Date.now(), val, slot, date, ts: new Date(date).getTime() }); }
            else if (entryType === 'bp') { const h = parseInt(document.getElementById('e-high').value), l = parseInt(document.getElementById('e-low').value); if (h && l) u.bps.push({ id: Date.now(), high: h, low: l, slot, date, ts: new Date(date).getTime() }); }
            else { const n = document.getElementById('e-name').value, c = parseInt(document.getElementById('e-cal').value); if (n && c) u.logs.unshift({ id: Date.now(), type: entryType, name: n, cal: c, slot, date }); }
            sync();
        }

        function deleteItem(id, type) {
            const u = users.find(x => x.id == curUid);
            if(type === 'interest') u.interests = u.interests.filter(i => i.id !== id);
            else if(type === 'log') u.logs = u.logs.filter(l => l.id !== id);
            sync();
        }

        function addUser() { const name = prompt("åç§°:"); if(name) { users.push({ id: Date.now(), name, target: 50, gender: 'female', weights: [], bps: [], logs: [], interests: [] }); sync(); } }
        function openManageModal() { const u = users.find(x => x.id == curUid); document.getElementById('m-name').value = u.name; document.getElementById('m-target').value = u.target; document.getElementById('manage-modal').classList.remove('hidden'); }
        function closeManageModal() { document.getElementById('manage-modal').classList.add('hidden'); }
        function saveUserManage() { const u = users.find(x => x.id == curUid); u.name = document.getElementById('m-name').value; u.target = parseFloat(document.getElementById('m-target').value); u.gender = document.getElementById('m-gender').value; closeManageModal(); sync(); }

        window.onload = () => { document.getElementById('global-date').value = new Date().toISOString().split('T')[0]; sync(); };
    </script>
</body>
</html>
