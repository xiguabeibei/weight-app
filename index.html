<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>HealthPro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --ios-green: #34c759; --bg: #f2f2f7; }
        
        * { 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation; 
            -webkit-user-select: none;
        }

        body { 
            margin: 0; background: var(--bg); color: #1c1c1e;
            font-family: -apple-system, system-ui, sans-serif;
            height: 100vh; overflow: hidden;
        }

        /* 适配 iPad 的滚动容器 */
        .scroll-container {
            height: 100vh; overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
        }

        /* 毛玻璃导航 */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }

        /* 卡片原生感 */
        .card { 
            background: white; border-radius: 24px; 
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
        }
        .card:active { transform: scale(0.98); }

        /* 隐藏滚动条 */
        .scroll-container::-webkit-scrollbar { display: none; }

        /* 底部导航 */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(70px + env(safe-area-inset-bottom));
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 12px; z-index: 1000;
        }

        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #8e8e93; }
        .nav-btn.active { color: var(--ios-green); }

        /* 响应式布局：iPad 横屏分两栏 */
        @media (min-width: 768px) {
            .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
            .full-width { grid-column: span 2; }
        }
    </style>
</head>
<body>

    <header class="glass fixed top-0 w-full z-50 pt-[env(safe-area-inset-top)] border-b border-gray-100">
        <div class="px-6 h-16 flex items-center justify-between">
            <h2 id="page-title" class="text-xl font-bold">健康看板</h2>
            <div class="flex items-center gap-4">
                <input type="date" id="global-date" onchange="refresh()" class="bg-transparent border-none text-blue-500 font-bold text-sm">
                <i data-lucide="settings" onclick="openSettings()" class="w-5 h-5 text-gray-400"></i>
            </div>
        </div>
    </header>

    <div class="scroll-container pt-24 px-4">
        
        <div id="view-home" class="page-content">
            <div class="grid-layout">
                <div class="card p-8 bg-gradient-to-br from-green-500 to-emerald-600 text-white shadow-xl shadow-green-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-black opacity-70 uppercase">Distance to Goal</p>
                            <h1 class="text-6xl font-black mt-1"><span id="diff-num">0.0</span><small class="text-xl ml-1">kg</small></h1>
                        </div>
                        <div class="bg-white/20 p-3 rounded-2xl">
                            <i data-lucide="target" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <p class="mt-6 text-sm font-bold opacity-90">目标体重: <span id="target-num">--</span> kg</p>
                </div>

                <div class="card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg">最近血压</h3>
                        <span id="bp-status" class="px-3 py-1 bg-green-100 text-green-600 rounded-full text-xs font-black">正常</span>
                    </div>
                    <div class="flex items-end gap-1">
                        <span id="bp-val" class="text-5xl font-black">--/--</span>
                        <span class="text-gray-300 font-bold mb-1 ml-2">mmHg</span>
                    </div>
                    <p class="text-xs text-gray-400 font-bold mt-4 italic" id="mood-text">点击记录今日感悟...</p>
                </div>

                <div class="card p-6 lg:col-span-1">
                    <div class="flex justify-between mb-6">
                        <span class="font-bold">体重轨迹</span>
                        <select onchange="changeRange('w', this.value)" class="text-xs font-bold bg-gray-50 border-none rounded-lg p-1">
                            <option value="7">7天</option>
                            <option value="30">1月</option>
                            <option value="90">3月</option>
                            <option value="365">1年</option>
                        </select>
                    </div>
                    <div class="h-64"><canvas id="wChart"></canvas></div>
                </div>

                <div class="card p-6 lg:col-span-1">
                    <div class="flex justify-between mb-6">
                        <span class="font-bold">血压/心率波动</span>
                        <select onchange="changeRange('bp', this.value)" class="text-xs font-bold bg-gray-50 border-none rounded-lg p-1">
                            <option value="7">7天</option>
                            <option value="30">1月</option>
                            <option value="365">1年</option>
                        </select>
                    </div>
                    <div class="h-64"><canvas id="bpChart"></canvas></div>
                </div>
            </div>
        </div>

        </div>

    <nav class="nav-bar glass">
        <button onclick="showSection('home')" class="nav-btn active" id="btn-home">
            <i data-lucide="layout-dashboard"></i><span class="text-[10px] font-black">概览</span>
        </button>
        <button onclick="triggerAdd()" class="nav-btn">
            <div class="w-12 h-12 bg-[#34c759] rounded-2xl flex items-center justify-center -translate-y-4 shadow-lg shadow-green-200">
                <i data-lucide="plus" class="text-white w-8 h-8"></i>
            </div>
        </button>
        <button onclick="showSection('list')" class="nav-btn" id="btn-list">
            <i data-lucide="list-checks"></i><span class="text-[10px] font-black">日志</span>
        </button>
    </nav>

    <script>
        // 数据持久化
        let db = JSON.parse(localStorage.getItem('health_pad_v1') || '{"weight":[], "bp":[], "target":65}');
        let wChart, bpChart;
        let ranges = { w: 7, bp: 7 };

        function refresh() {
            lucide.createIcons();
            const sortedW = [...db.weight].sort((a,b)=>a.ts-b.ts);
            const latestW = sortedW.length ? sortedW[sortedW.length-1].val : db.target;
            
            document.getElementById('target-num').innerText = db.target;
            document.getElementById('diff-num').innerText = (latestW - db.target).toFixed(1);
            
            const vDate = document.getElementById('global-date').value;
            const todayBP = db.bp.filter(i => i.date === vDate)[0];
            if(todayBP) {
                document.getElementById('bp-val').innerText = `${todayBP.high}/${todayBP.low}`;
            }

            renderCharts();
        }

        function renderCharts() {
            const filter = (arr, d) => arr.filter(i => i.ts >= Date.now() - d*86400000).sort((a,b)=>a.ts-b.ts);
            
            // 体重
            const wd = filter(db.weight, ranges.w);
            if(wChart) wChart.destroy();
            wChart = new Chart(document.getElementById('wChart'), {
                type: 'line',
                data: { labels: wd.map(d=>d.date.slice(5)), datasets: [{ data: wd.map(d=>d.val), borderColor: '#34c759', borderWidth: 5, pointRadius: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(52,199,89,0.05)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 血压
            const bd = filter(db.bp, ranges.bp);
            if(bpChart) bpChart.destroy();
            bpChart = new Chart(document.getElementById('bpChart'), {
                type: 'line',
                data: {
                    labels: bd.map(d=>d.date.slice(5)),
                    datasets: [
                        { label: '高压', data: bd.map(d=>d.high), borderColor: '#ff3b30', borderWidth: 3, pointRadius: 0, tension: 0.4 },
                        { label: '心率', data: bd.map(d=>d.hr), borderColor: '#ff2d55', borderWidth: 2, borderDash: [5,5], pointRadius: 0, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function triggerAdd() {
            const w = prompt("输入体重 (KG):");
            const h = prompt("输入收缩压 (高压):");
            const l = prompt("输入舒张压 (低压):");
            const hr = prompt("输入心率 (BPM):");
            const date = document.getElementById('global-date').value;

            if(w) db.weight.push({ val: parseFloat(w), date, ts: new Date(date).getTime(), slot: '记录' });
            if(h && l) db.bp.push({ high: parseInt(h), low: parseInt(l), hr: parseInt(hr)||70, date, ts: new Date(date).getTime(), slot: '记录' });
            
            localStorage.setItem('health_pad_v1', JSON.stringify(db));
            refresh();
        }

        function changeRange(type, val) {
            ranges[type] = parseInt(val);
            renderCharts();
        }

        function openSettings() {
            const t = prompt("设置你的目标体重:", db.target);
            if(t) { db.target = parseFloat(t); localStorage.setItem('health_pad_v1', JSON.stringify(db)); refresh(); }
        }

        window.onload = () => {
            document.getElementById('global-date').value = new Date().toISOString().split('T')[0];
            refresh();
            
            // iPad 禁止橡皮筋缩放效果
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });
        };
    </script>
</body>
</html>
