<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çŒ«çŒ«å¥åº·">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3567/3567440.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3567/3567440.png">

    <title>ä¸ƒå½©æ¢¦å¹»å…¨åŠŸèƒ½æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;900&display=swap');
        
        body { 
            background: linear-gradient(-45deg, #fff0f3, #e7f5ff, #f3f0ff, #fff9db);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #444;
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        /* å°çŒ«é£˜è½ */
        .cat-bg { position: fixed; top: -10%; z-index: -1; pointer-events: none; animation: catFall linear infinite; font-size: 24px; }
        @keyframes catFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        .floating-card {
            background: rgba(255, 255, 255, 0.85);
            border: 4px solid white;
            backdrop-filter: blur(15px);
            border-radius: 2.5rem;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
        }

        .card-blue { border-color: #bae1ff; } .card-green { border-color: #baffc9; } .card-purple { border-color: #decaff; } .card-yellow { border-color: #ffffba; } .card-orange { border-color: #ffdfba; } .card-red { border-color: #ffc9c9; }

        /* æ»‘åŠ¨åˆ é™¤ */
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-x; border-radius: 1.5rem; margin-bottom: 1rem; background: #ff6b6b !important; }
        .swipe-content { position: relative; z-index: 20; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); background: white !important; width: 100%; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; color: white; display: flex; align-items: center; justify-content: center; z-index: 10; font-weight: 900; }

        .sidebar-active { background: #444 !important; color: white !important; transform: translateX(10px); }
        .text-pop { font-family: 'ZCOOL KuaiLe', cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen p-4 gap-6">

    <div id="cat-container"></div>

    <aside class="w-72 flex flex-col p-6 floating-card">
        <div class="flex flex-col items-center gap-2 mb-10">
            <div class="w-16 h-16 rounded-3xl bg-gradient-to-br from-yellow-300 to-orange-400 flex items-center justify-center shadow-2xl rotate-12 text-white"><i data-lucide="cat"></i></div>
            <h1 class="text-pop text-2xl mt-2 tracking-widest text-orange-500">çŒ«çŒ«æ—¥è®°</h1>
        </div>
        <nav id="user-nav" class="flex-1 space-y-3 overflow-y-auto no-scrollbar px-2"></nav>
        <div class="pt-6 border-t-2 border-dashed border-gray-100 space-y-3">
            <button onclick="addUser()" class="w-full p-4 rounded-2xl bg-green-400 text-white flex items-center justify-center gap-3 font-black shadow-lg">æ–°æˆå‘˜</button>
            <button onclick="openManageModal()" class="w-full p-4 rounded-2xl text-gray-400 font-bold hover:bg-gray-50 flex items-center justify-center gap-3"><i data-lucide="settings"></i> æ¡£æ¡ˆè®¾ç½®</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar space-y-8 pb-10 px-2">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section class="lg:col-span-2 floating-card card-green p-10 relative overflow-hidden group">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="flex items-center gap-6 mb-4">
                            <h2 id="display-name" class="text-pop text-6xl text-green-600">--</h2>
                            <div id="display-gender-icon" class="animate-bounce"></div>
                        </div>
                        <div class="inline-block bg-green-500 text-white px-4 py-1 rounded-lg text-xs font-black shadow-lg" id="display-wish">--</div>
                    </div>
                    <div class="text-right">
                        <div id="status-tag" class="text-7xl text-pop leading-none text-green-500">0.0</div>
                        <p class="text-[10px] font-black opacity-30 mt-2 italic tracking-widest text-green-700">KG REMAINING</p>
                    </div>
                </div>
                <div id="mood-display" class="mt-8 p-5 rounded-3xl bg-white/60 border-2 border-dashed border-green-200 text-sm font-bold italic text-green-700">ğŸ± çŠ¶æ€: --</div>
            </section>

            <section class="floating-card card-purple p-8 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="text-pop text-lg text-purple-500">âœ¨ æ¯æ—¥ä¹ æƒ¯</h4>
                    <button onclick="addInterest()" class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center"><i data-lucide="plus"></i></button>
                </div>
                <div id="interest-list" class="space-y-4 overflow-y-auto no-scrollbar flex-1"></div>
            </section>
        </div>

        <section class="floating-card card-blue p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-pop text-lg text-blue-500">ğŸ¾ ç˜¦èº«è¿›åº¦</h3>
                <div id="progress-percent" class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-xs font-black">0%</div>
            </div>
            <div class="relative w-full h-8 bg-blue-50 rounded-full p-1.5 overflow-hidden border border-blue-100">
                <div id="progress-bar" class="bg-blue-400 h-full rounded-full w-0 transition-all duration-1000"></div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="floating-card card-yellow p-8">
                <h3 class="text-pop text-xl text-yellow-600 mb-6"><i data-lucide="line-chart"></i> ä½“é‡æ›²çº¿</h3>
                <div class="h-64"><canvas id="weightChart"></canvas></div>
            </section>
            <section class="floating-card card-red p-8">
                <h3 class="text-pop text-xl text-red-500 mb-6"><i data-lucide="heart-pulse"></i> è¡€å‹åŒæ›²çº¿</h3>
                <div class="h-64"><canvas id="bpChart"></canvas></div>
            </section>
        </div>

        <section class="floating-card card-orange p-8">
            <div class="flex flex-wrap items-center justify-between gap-6 mb-8">
                <input type="date" id="global-date" onchange="render()" class="font-black text-xl text-orange-600 bg-orange-50 p-3 rounded-2xl border-none shadow-inner">
                <div class="flex gap-2 p-2 bg-orange-100 rounded-3xl">
                    <button onclick="setLogType('weight')" id="tab-weight" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">ä½“é‡</button>
                    <button onclick="setLogType('bp')" id="tab-bp" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">è¡€å‹</button>
                    <button onclick="setLogType('food')" id="tab-food" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">è¡¥ç»™</button>
                    <button onclick="setLogType('sport')" id="tab-sport" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">è¿åŠ¨</button>
                </div>
            </div>
            <div id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 pb-20">
            <div id="list-food"></div>
            <div id="list-sport"></div>
        </div>
    </main>

    <div id="manage-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-xl z-50 flex items-center justify-center p-6">
        <div class="floating-card p-12 w-full max-w-2xl bg-white shadow-2xl">
            <h2 class="text-pop text-3xl mb-10 text-gray-700">æ¡£æ¡ˆä¿®æ”¹</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <input type="text" id="m-name" placeholder="åç§°" class="p-5 rounded-2xl bg-gray-50 border-none">
                <select id="m-gender" class="p-5 rounded-2xl bg-gray-50 border-none"><option value="female">å¥³ç”Ÿ</option><option value="male">ç”·ç”Ÿ</option></select>
                <input type="number" id="m-target" placeholder="ç›®æ ‡ä½“é‡" class="p-5 rounded-2xl bg-gray-50 border-none">
                <input type="text" id="m-wish" placeholder="æ„¿æœ›" class="p-5 rounded-2xl bg-gray-50 border-none">
                <textarea id="m-mood" placeholder="ä»Šæ—¥è§‰æ‚Ÿ" class="md:col-span-2 p-5 rounded-2xl bg-gray-50 border-none h-24"></textarea>
            </div>
            <div class="flex gap-6 mt-12">
                <button onclick="closeManageModal()" class="flex-1 font-black opacity-40">å–æ¶ˆ</button>
                <button onclick="saveUserManage()" class="flex-1 p-6 bg-gray-800 text-white rounded-3xl font-black">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('sf_colorful_pro_v3') || '[]');
        let curUid = localStorage.getItem('sf_colorful_uid') || (users[0]?.id || null);
        let entryType = 'weight', charts = {};

        function createCat() {
            const container = document.getElementById('cat-container');
            const cat = document.createElement('div');
            cat.className = 'cat-bg';
            cat.style.left = Math.random() * 100 + 'vw';
            cat.innerText = ['ğŸ±', 'ğŸˆ', 'ğŸ¾', 'ğŸ˜¸', 'ğŸ˜»'][Math.floor(Math.random()*5)];
            cat.style.animationDuration = Math.random() * 5 + 8 + 's';
            container.appendChild(cat);
            setTimeout(() => cat.remove(), 12000);
        }
        setInterval(createCat, 800);

        function sync() {
            localStorage.setItem('sf_colorful_pro_v3', JSON.stringify(users));
            if(curUid) localStorage.setItem('sf_colorful_uid', curUid);
            render();
        }

        // æ»‘åŠ¨åˆ é™¤é€»è¾‘
        let tStart = 0, currentSwipeEl = null;
        document.addEventListener('touchstart', e => {
            const container = e.target.closest('.swipe-container');
            if (container) {
                document.querySelectorAll('.swipe-content').forEach(el => { if(el !== container.querySelector('.swipe-content')) el.style.transform = 'translateX(0)'; });
                tStart = e.touches[0].clientX;
                currentSwipeEl = container.querySelector('.swipe-content');
            }
        });
        document.addEventListener('touchmove', e => {
            if (!currentSwipeEl) return;
            const diff = e.touches[0].clientX - tStart;
            if (diff < 0) currentSwipeEl.style.transform = `translateX(${Math.max(diff, -80)}px)`;
        });
        document.addEventListener('touchend', e => {
            if (!currentSwipeEl) return;
            const diff = e.changedTouches[0].clientX - tStart;
            currentSwipeEl.style.transform = diff < -40 ? `translateX(-80px)` : `translateX(0)`;
            currentSwipeEl = null;
        });

        function addUser() {
            const name = prompt("æˆå‘˜åç§°:"); if(!name) return;
            const u = { id: Date.now(), name, target: 50, gender: 'female', weights: [], bps: [], logs: [], interests: [] };
            users.push(u); curUid = u.id; sync();
        }

        function deleteItem(id, listType) {
            const u = users.find(x => x.id == curUid);
            if(listType === 'user') { users = users.filter(u => u.id !== id); curUid = users[0]?.id || null; }
            else if(listType === 'interest') u.interests = u.interests.filter(i => i.id !== id);
            else if(listType === 'log') u.logs = u.logs.filter(l => l.id !== id);
            sync();
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const date = document.getElementById('global-date').value;
            const slot = document.getElementById('e-slot').value;

            if (entryType === 'weight') {
                const val = parseFloat(document.getElementById('e-val').value);
                if (val) {
                    const idx = u.weights.findIndex(w => w.date === date && w.slot === slot);
                    if (idx > -1) u.weights[idx].val = val;
                    else u.weights.push({ id: Date.now(), val, slot, date, ts: new Date(date).getTime() });
                }
            } else if (entryType === 'bp') {
                const high = parseInt(document.getElementById('e-high').value);
                const low = parseInt(document.getElementById('e-low').value);
                if (high && low) u.bps.push({ id: Date.now(), high, low, slot, date, ts: new Date(date).getTime() });
            } else {
                const name = document.getElementById('e-name').value, cal = parseInt(document.getElementById('e-cal').value);
                if (name && cal) u.logs.unshift({ id: Date.now(), type: entryType, name, cal, slot, date });
            }
            sync();
        }

        function render() {
            const uNav = document.getElementById('user-nav');
            uNav.innerHTML = users.map(u => `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${u.id}, 'user')">åˆ é™¤</div>
                    <div onclick="curUid=${u.id};sync()" class="swipe-content p-5 cursor-pointer flex items-center gap-4 ${curUid == u.id ? 'sidebar-active' : 'text-gray-400'}">
                        <span class="font-black text-sm flex-1">${u.name}</span>
                        <i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-4 h-4 opacity-40"></i>
                    </div>
                </div>`).join('');
            
            const u = users.find(x => x.id == curUid); if(!u) return;

            // ä¸ªäººä¿¡æ¯æ˜¾ç¤º
            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-wish').innerText = 'æ„¿æœ›ï¼š' + (u.wish || 'å¥åº·ç”Ÿæ´»');
            document.getElementById('mood-display').innerText = `ğŸ± çŠ¶æ€: ${u.mood || 'æ¯å¤©éƒ½è¦ç¾ç¾çš„'}`;
            document.getElementById('display-gender-icon').innerHTML = `<i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-10 h-10 ${u.gender==='male'?'text-blue-400':'text-pink-400'}"></i>`;

            // ä½“é‡è¿›åº¦
            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const curW = sortedW.length ? sortedW[sortedW.length-1].val : u.target;
            const diff = (curW - u.target).toFixed(1);
            document.getElementById('status-tag').innerText = (diff > 0 ? "+" : "") + diff;
            
            const progress = sortedW.length ? Math.min(100, Math.max(0, (sortedW[0].val - curW) / (sortedW[0].val - u.target) * 100)) : 0;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-percent').innerText = Math.round(progress) + '%';

            // ä¹ æƒ¯åˆ—è¡¨
            document.getElementById('interest-list').innerHTML = (u.interests || []).map(i => `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${i.id}, 'interest')">åˆ é™¤</div>
                    <div class="swipe-content p-5 border-2 border-purple-50 flex items-center gap-4">
                        <i data-lucide="zap" class="text-purple-400"></i>
                        <span class="font-black text-sm text-purple-700">${i.name}</span>
                    </div>
                </div>`).join('');

            // è®°å½•åˆ—è¡¨
            const gDate = document.getElementById('global-date').value;
            const logs = u.logs.filter(l => l.date === gDate);
            const logTpl = (l, color) => `
                <div class="swipe-container">
                    <div class="delete-action" onclick="deleteItem(${l.id}, 'log')">åˆ é™¤</div>
                    <div class="swipe-content p-4 border-2 border-${color}-50 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="bg-${color}-100 p-2 rounded-lg text-${color}-500"><i data-lucide="coffee" class="w-4 h-4"></i></div>
                            <div><div class="font-black text-sm">${l.name}</div><div class="text-[9px] opacity-30">${l.slot}</div></div>
                        </div>
                        <div class="font-black text-${color}-500">${l.cal} KCAL</div>
                    </div>
                </div>`;
            document.getElementById('list-food').innerHTML = `<h4 class="text-pop text-orange-500 mb-4">ğŸª è¡¥ç»™</h4>` + logs.filter(l=>l.type==='food').map(l=>logTpl(l, 'orange')).join('');
            document.getElementById('list-sport').innerHTML = `<h4 class="text-pop text-blue-500 mb-4">âš¡ ç‡ƒçƒ§</h4>` + logs.filter(l=>l.type==='sport').map(l=>logTpl(l, 'blue')).join('');

            updateCharts(u);
            renderEntryForm();
            lucide.createIcons();
        }

        function updateCharts(u) {
            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const sortedBP = [...u.bps].sort((a,b)=>a.ts-b.ts);

            if(charts.w) charts.w.destroy();
            charts.w = new Chart(document.getElementById('weightChart').getContext('2d'), {
                type: 'line',
                data: { labels: sortedW.map(w=>w.date.slice(5)), datasets: [{ data: sortedW.map(w=>w.val), borderColor: '#fcc419', tension: 0.4, fill: true, backgroundColor: 'rgba(252,196,25,0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            if(charts.bp) charts.bp.destroy();
            charts.bp = new Chart(document.getElementById('bpChart').getContext('2d'), {
                type: 'line',
                data: { labels: sortedBP.map(b=>b.date.slice(5)), datasets: [
                    { label: 'é«˜å‹', data: sortedBP.map(b=>b.high), borderColor: '#ff6b6b', tension: 0.4 },
                    { label: 'ä½å‹', data: sortedBP.map(b=>b.low), borderColor: '#4dabf7', tension: 0.4 }
                ]},
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function setLogType(t) { entryType = t; renderEntryForm(); }
        function renderEntryForm() {
            const container = document.getElementById('entry-form');
            const btns = ['weight', 'bp', 'food', 'sport'];
            btns.forEach(t => document.getElementById('tab-'+t).className = entryType === t ? 'px-6 py-2 rounded-2xl font-black text-xs bg-orange-500 text-white shadow-lg' : 'px-6 py-2 rounded-2xl font-black text-xs text-orange-300');

            if(entryType === 'weight') container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl border-none shadow-inner"><option value="æ™¨é—´">æ—©æ™¨</option><option value="æ™šé—´">ç¡å‰</option></select><input type="number" id="e-val" placeholder="ä½“é‡(KG)" class="p-4 rounded-2xl border-none shadow-inner md:col-span-2"><button onclick="submitEntry()" class="bg-orange-500 text-white rounded-2xl font-black">è®°å½•</button>`;
            else if(entryType === 'bp') container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl border-none shadow-inner"><option value="æ™¨é—´">æ—©æ™¨</option><option value="æ™šé—´">ç¡å‰</option></select><input type="number" id="e-high" placeholder="æ”¶ç¼©å‹" class="p-4 rounded-2xl border-none shadow-inner"><input type="number" id="e-low" placeholder="èˆ’å¼ å‹" class="p-4 rounded-2xl border-none shadow-inner"><button onclick="submitEntry()" class="bg-red-400 text-white rounded-2xl font-black">è®°å½•</button>`;
            else {
                const s = entryType === 'food' ? ["æ—©é¤","ä¸‹åˆèŒ¶","æ™šé¤"] : ["è·³æ“","æ’¸çŒ«","æ•£æ­¥"];
                container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl border-none shadow-inner">${s.map(x=>`<option value="${x}">${x}</option>`).join('')}</select><input type="text" id="e-name" placeholder="å†…å®¹" class="p-4 rounded-2xl border-none shadow-inner"><input type="number" id="e-cal" placeholder="KCAL" class="p-4 rounded-2xl border-none shadow-inner"><button onclick="submitEntry()" class="bg-blue-400 text-white rounded-2xl font-black">è®°å½•</button>`;
            }
        }

        function addInterest() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const name = prompt("è¾“å…¥æ–°ä¹ æƒ¯ï¼š");
            if(name) { u.interests.push({ id: Date.now(), name }); sync(); }
        }

        function openManageModal() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            document.getElementById('m-name').value = u.name;
            document.getElementById('m-target').value = u.target;
            document.getElementById('m-wish').value = u.wish || '';
            document.getElementById('m-mood').value = u.mood || '';
            document.getElementById('manage-modal').classList.remove('hidden');
        }
        function closeManageModal() { document.getElementById('manage-modal').classList.add('hidden'); }
        function saveUserManage() {
            const u = users.find(x => x.id == curUid);
            u.name = document.getElementById('m-name').value;
            u.target = parseFloat(document.getElementById('m-target').value);
            u.wish = document.getElementById('m-wish').value;
            u.mood = document.getElementById('m-mood').value;
            u.gender = document.getElementById('m-gender').value;
            closeManageModal(); sync();
        }

        window.onload = () => {
            document.getElementById('global-date').value = new Date().toISOString().split('T')[0];
            sync();
        };
    </script>
</body>
</html>
