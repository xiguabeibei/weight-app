<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartFit Pro - å®¶åº­å¥åº·è®°å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        body { font-family: 'Nunito', sans-serif; background: #f4f7ff; color: #1e293b; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.4); }
        .sidebar-active { background: #6366f1; color: white; box-shadow: 0 8px 15px rgba(99, 102, 241, 0.2); }
        .tech-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .progress-bar-bg { background: #e2e8f0; height: 20px; border-radius: 50px; overflow: hidden; position: relative; }
        .progress-fill { background: linear-gradient(90deg, #6366f1, #a855f7); transition: width 1s ease-in-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 glass m-4 mr-0 rounded-[2.5rem] flex flex-col p-6 shadow-xl">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 tech-gradient rounded-xl flex items-center justify-center text-white"><i data-lucide="sparkles"></i></div>
            <h1 class="font-900 text-xl tracking-tight italic">FamilyFit</h1>
        </div>
        <nav id="user-nav" class="flex-1 space-y-3 overflow-y-auto custom-scrollbar"></nav>
        <button onclick="openUserModal()" class="mt-4 p-4 border-2 border-dashed border-indigo-200 rounded-2xl text-indigo-400 hover:bg-indigo-50 flex items-center justify-center gap-2 font-bold transition-all">
            <i data-lucide="plus"></i> æ–°æˆå‘˜
        </button>
    </aside>

    <main class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
        <div class="max-w-6xl mx-auto space-y-6">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass p-8 rounded-[3rem] shadow-sm flex flex-col justify-between min-h-[300px]">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 id="display-name" class="text-3xl font-900">è¯·é€‰æ‹©æˆå‘˜</h2>
                            <p class="text-slate-400 font-bold mt-1 text-lg">ç›®æ ‡: <span id="tar-w-txt">0</span>kg</p>
                        </div>
                        <div class="text-right">
                            <span id="status-tag" class="text-5xl font-black tabular-nums">0.0</span>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">è·ç¦»ç›®æ ‡ Gap</p>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex justify-between text-xs font-bold mb-2 text-indigo-500">
                            <span>å½“å‰è¿›åº¦</span>
                            <span id="prog-percent">0%</span>
                        </div>
                        <div class="progress-bar-bg shadow-inner">
                            <div id="progress-fill" class="progress-fill h-full w-0"></div>
                            <div class="absolute right-0 top-0 h-full w-1.5 bg-indigo-200 opacity-50"></div>
                        </div>
                        <p id="motivate-txt" class="mt-4 text-center font-bold text-slate-500 italic bg-white/50 py-3 rounded-2xl">--</p>
                    </div>
                </div>

                <div class="glass p-8 rounded-[3rem] shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-slate-700 flex items-center gap-2"><i data-lucide="activity"></i> ä½“é‡è¶‹åŠ¿</h3>
                        <div class="flex bg-indigo-50 p-1 rounded-xl text-xs font-bold" id="ranges">
                            <button onclick="updateRange(7)" id="r7" class="px-4 py-2 rounded-lg">7å¤©</button>
                            <button onclick="updateRange(30)" id="r30" class="px-4 py-2 rounded-lg">30å¤©</button>
                            <button onclick="updateRange(90)" id="r90" class="px-4 py-2 rounded-lg">ä¸‰æœˆ</button>
                        </div>
                    </div>
                    <div class="h-52 w-full"><canvas id="weightChart"></canvas></div>
                </div>
            </div>

            <div class="glass p-8 rounded-[3rem] shadow-sm">
                <div class="flex flex-wrap items-center gap-4 mb-8">
                    <h3 class="font-black text-slate-700 text-xl flex items-center gap-2"><i data-lucide="calendar-plus"></i> å†å²è¡¥è®°</h3>
                    <input type="date" id="global-date" class="bg-indigo-50 px-4 py-2 rounded-xl font-bold outline-none text-indigo-600 border border-indigo-100">
                    <div class="h-6 w-px bg-slate-200 mx-2"></div>
                    <div class="flex gap-2">
                        <button onclick="setLogType('weight')" id="tab-weight" class="px-6 py-2 rounded-xl font-black text-sm transition-all border shadow-sm">âš–ï¸ è¡¥ä½“é‡</button>
                        <button onclick="setLogType('food')" id="tab-food" class="px-6 py-2 rounded-xl font-black text-sm transition-all border shadow-sm">ğŸ è¡¥é¥®é£Ÿ</button>
                        <button onclick="setLogType('sport')" id="tab-sport" class="px-6 py-2 rounded-xl font-black text-sm transition-all border shadow-sm">âš¡ è¡¥è¿åŠ¨</button>
                    </div>
                </div>

                <div id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white/40 p-6 rounded-[2rem] border border-white">
                    </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
                <div class="glass rounded-[3rem] p-8 min-h-[300px]">
                    <h4 class="font-black text-orange-500 mb-6 flex items-center gap-2 text-lg"><i data-lucide="utensils"></i> é¥®é£Ÿæ˜ç»† (Intake)</h4>
                    <div id="list-food" class="space-y-3"></div>
                </div>
                <div class="glass rounded-[3rem] p-8 min-h-[300px]">
                    <h4 class="font-black text-green-500 mb-6 flex items-center gap-2 text-lg"><i data-lucide="dumbbell"></i> è¿åŠ¨æ˜ç»† (Burn)</h4>
                    <div id="list-sport" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="u-modal" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-md z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-[3rem] p-10 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-900 mb-8 text-slate-800 text-center">æ–°æˆå‘˜åŠ å…¥</h2>
            <div class="space-y-5">
                <input type="text" id="nu-name" placeholder="æˆå‘˜å§“å" class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold text-lg border-2 border-transparent focus:border-indigo-400">
                <input type="number" id="nu-target" placeholder="ç›®æ ‡ä½“é‡ (kg)" class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold text-lg border-2 border-transparent focus:border-indigo-400">
                <div class="flex gap-4 pt-4">
                    <button onclick="closeUserModal()" class="flex-1 font-bold text-slate-400 hover:text-slate-600">å–æ¶ˆ</button>
                    <button onclick="addUser()" class="flex-1 p-5 tech-gradient text-white rounded-[1.5rem] font-black shadow-lg">å¼€å¯è®°å½•</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('sf_v4') || '[]');
        let curUid = localStorage.getItem('sf_v4_uid') || null;
        let activeRange = 30;
        let entryType = 'weight'; 
        let chart = null;

        const quotes = {
            gain: ["ç”Ÿæ´»éœ€è¦ä¸€ç‚¹è‚‰è‚‰ï¼Œä½†ä»Šå¤©è¿åŠ¨äº†å—ï¼Ÿ", "åˆ«ç°å¿ƒï¼Œä½“é‡åªæ˜¯æ•°å­—ï¼Œä½ æ˜¯æ— ä»·çš„ï¼", "å¤šå‡ºçš„é‡é‡æ˜¯å¥½èƒƒå£çš„è¯æ®ï¼ŒåŠ æ²¹å‡æ‰å®ƒï¼"],
            lose: ["å“‡ï¼ç¦»ç›®æ ‡è¶Šæ¥è¶Šè¿‘ï¼Œä½ ç®€ç›´åœ¨å‘å…‰ï¼", "åšæŒå°±æ˜¯èƒœåˆ©ï¼Œç°åœ¨çš„ä½ ç¾æäº†ï¼", "è½»ç›ˆå¦‚ç‡•çš„æ„Ÿè§‰æŒ‡æ—¥å¯å¾…ï¼"],
            reach: ["ç›®æ ‡è¾¾æˆï¼ä½ æ˜¯è‡ªå·±çš„å† å†›ï¼", "å¤ªå¼ºäº†ï¼è¿™æ˜¯å±äºè‡ªå¾‹è€…çš„æ—¶åˆ»ï¼"]
        };

        document.getElementById('global-date').valueAsDate = new Date();

        function sync() {
            localStorage.setItem('sf_v4', JSON.stringify(users));
            if(curUid) localStorage.setItem('sf_v4_uid', curUid);
            render();
        }

        function addUser() {
            const name = document.getElementById('nu-name').value, target = parseFloat(document.getElementById('nu-target').value);
            if(!name || !target) return;
            const u = { id: Date.now(), name, target, weights: [], logs: [] };
            users.push(u); curUid = u.id;
            closeUserModal(); sync();
        }

        function setLogType(t) {
            entryType = t;
            renderEntryForm();
        }

        function renderEntryForm() {
            const container = document.getElementById('entry-form');
            const btnW = document.getElementById('tab-weight'), btnF = document.getElementById('tab-food'), btnS = document.getElementById('tab-sport');
            
            // é‡ç½®æ ·å¼
            [btnW, btnF, btnS].forEach(b => b.className = "px-6 py-2 rounded-xl font-black text-sm transition-all bg-white text-slate-400 border-slate-100 shadow-sm hover:text-indigo-500");
            
            if(entryType === 'weight') {
                btnW.className = "px-6 py-2 rounded-xl font-black text-sm transition-all bg-indigo-600 text-white shadow-md border-indigo-600";
                container.innerHTML = `
                    <select id="e-slot" class="bg-white p-4 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-indigo-400">
                        <option value="morning">æ™¨é—´ (AM)</option><option value="evening">æ™šé—´ (PM)</option>
                    </select>
                    <input type="number" id="e-val" step="0.1" placeholder="ä½“é‡ (kg)" class="bg-white p-4 rounded-2xl font-bold outline-none md:col-span-2">
                    <button onclick="submitEntry()" class="tech-gradient text-white p-4 rounded-2xl font-black">è®°å½•ä½“é‡</button>
                `;
            } else {
                const isFood = entryType === 'food';
                if(isFood) btnF.className = "px-6 py-2 rounded-xl font-black text-sm transition-all bg-orange-500 text-white shadow-md border-orange-500";
                else btnS.className = "px-6 py-2 rounded-xl font-black text-sm transition-all bg-green-500 text-white shadow-md border-green-500";
                
                container.innerHTML = `
                    <select id="e-slot" class="bg-white p-4 rounded-2xl font-bold outline-none">
                        <option value="æ—©èµ·">æ—©èµ·</option><option value="ä¸­åˆ">ä¸­åˆ</option>
                        <option value="ä¸‹åˆèŒ¶">ä¸‹åˆèŒ¶</option><option value="æ™šä¸Š">æ™šä¸Š</option><option value="å®µå¤œ">å®µå¤œ</option>
                    </select>
                    <input type="text" id="e-name" placeholder="åç§° (å¦‚: è·‘æ­¥/ç±³é¥­)" class="bg-white p-4 rounded-2xl font-bold outline-none md:col-span-1">
                    <input type="number" id="e-cal" placeholder="å¡è·¯é‡Œ" class="bg-white p-4 rounded-2xl font-bold outline-none">
                    <button onclick="submitEntry()" class="${isFood ? 'bg-orange-500' : 'bg-green-500'} text-white p-4 rounded-2xl font-black shadow-lg">è¡¥è®°æ—¥å¿—</button>
                `;
            }
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid);
            if(!u) return;
            const date = document.getElementById('global-date').value;
            const slot = document.getElementById('e-slot').value;

            if(entryType === 'weight') {
                const val = parseFloat(document.getElementById('e-val').value);
                if(!val) return;
                const exist = u.weights.find(x => x.date === date && x.slot === slot);
                if(exist) exist.val = val; 
                else u.weights.push({ val, slot, date, ts: new Date(date).getTime() + (slot === 'morning' ? 0 : 43200) });
                u.weights.sort((a,b) => a.ts - b.ts);
            } else {
                const name = document.getElementById('e-name').value, cal = parseInt(document.getElementById('e-cal').value);
                if(!name || !cal) return;
                u.logs.unshift({ type: entryType, name, cal, slot, date, ts: Date.now() });
            }
            sync();
        }

        function openUserModal() { document.getElementById('u-modal').classList.remove('hidden'); }
        function closeUserModal() { document.getElementById('u-modal').classList.add('hidden'); }
        function updateRange(r) { activeRange = r; render(); }

        function render() {
            const nav = document.getElementById('user-nav');
            nav.innerHTML = users.map(u => `<button onclick="curUid=${u.id};sync()" class="w-full flex items-center gap-4 p-5 rounded-[1.5rem] transition-all ${curUid == u.id ? 'sidebar-active shadow-lg' : 'text-slate-500 hover:bg-white'}"><i data-lucide="user-circle"></i><span class="font-black text-lg">${u.name}</span></button>`).join('');
            
            const u = users.find(x => x.id == curUid);
            if(!u) { renderEntryForm(); return lucide.createIcons(); }

            document.getElementById('display-name').innerText = u.name;
            const curW = u.weights[u.weights.length-1]?.val || 0;
            document.getElementById('tar-w-txt').innerText = u.target;
            
            // è¿›åº¦æ¡é€»è¾‘
            const startW = u.weights[0]?.val || curW + 5;
            const percent = Math.min(100, Math.max(8, (Math.abs(startW - curW) / (Math.abs(startW - u.target) || 1)) * 100));
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('prog-percent').innerText = Math.round(percent) + '%';
            
            const diff = (curW - u.target).toFixed(1);
            const tag = document.getElementById('status-tag');
            tag.innerText = (diff > 0 ? "+" : "") + diff;
            tag.className = diff <= 0 ? "text-5xl font-black text-green-500 tabular-nums" : "text-5xl font-black text-indigo-600 tabular-nums";

            const mBox = document.getElementById('motivate-txt');
            if(diff > 0) mBox.innerText = quotes.gain[Math.floor(Math.random()*3)];
            else if(diff <= 0 && diff > -1) mBox.innerText = quotes.reach[Math.floor(Math.random()*2)];
            else mBox.innerText = quotes.lose[Math.floor(Math.random()*3)];

            // æ—¥å¿—å±•ç¤º
            const gDate = document.getElementById('global-date').value;
            const dayLogs = u.logs.filter(x => x.date === gDate);
            const logItem = (l) => `<div class="p-5 glass rounded-[1.5rem] flex justify-between items-center shadow-sm"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-xl flex items-center justify-center ${l.type==='food'?'bg-orange-100 text-orange-500':'bg-green-100 text-green-500'}"><i data-lucide="${l.type==='food'?'apple':'zap'}" class="w-4 h-4"></i></div><div><div class="font-black text-slate-700">${l.name}</div><div class="text-[10px] font-bold text-slate-400">${l.slot}</div></div></div><div class="font-black text-lg">${l.type==='food'?'+':'-'}${l.cal} <span class="text-xs">kcal</span></div></div>`;
            
            document.getElementById('list-food').innerHTML = dayLogs.filter(x => x.type === 'food').map(logItem).join('') || '<p class="text-center py-10 text-slate-300 font-bold">æ— è®°å½•</p>';
            document.getElementById('list-sport').innerHTML = dayLogs.filter(x => x.type === 'sport').map(logItem).join('') || '<p class="text-center py-10 text-slate-300 font-bold">æ— è®°å½•</p>';

            [7, 30, 90].forEach(r => document.getElementById(`r${r}`).className = activeRange === r ? "px-4 py-2 bg-white text-indigo-600 rounded-lg shadow-sm" : "px-4 py-2 text-slate-400");
            
            renderEntryForm();
            renderChart(u.weights);
            lucide.createIcons();
        }

        function renderChart(ws) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const cutoff = Date.now() - activeRange * 86400000;
            const f = ws.filter(x => x.ts >= cutoff);
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: f.map(x => x.date.slice(5) + (x.slot === 'morning' ? ' AM' : ' PM')),
                    datasets: [{
                        data: f.map(x => x.val),
                        borderColor: '#6366f1', borderWidth: 4, pointRadius: 5, tension: 0.4, fill: true,
                        backgroundColor: (c) => { const g = ctx.createLinearGradient(0,0,0,200); g.addColorStop(0,'rgba(99,102,241,0.15)'); g.addColorStop(1,'transparent'); return g; }
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false }, tooltip: { padding: 12, bodyFont: { size: 16, weight: 'bold' } } }, 
                    scales: { y: { grid: { color: '#f0f0f0' }, border: { display: false } }, x: { display: false } } 
                }
            });
        }
        window.onload = render;
    </script>
</body>
</html>
