<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>健康管理Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f2f2f7; font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; position: fixed; }
        #main-scroll { height: 100vh; overflow-y: auto; padding-top: calc(85px + env(safe-area-inset-top)); padding-bottom: 120px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .sidebar-hidden { transform: translateX(-100%); position: absolute; }
        #sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
        input, select { outline: none; border-radius: 12px; padding: 12px; font-size: 16px; background: #f2f2f7; border: none; width: 100%; }
        .tab-active { color: #34c759; border-bottom: 3px solid #34c759; }
        /* 滑动删除 */
        .swipe-container { position: relative; overflow: hidden; border-radius: 15px; margin-bottom: 8px; background: #ff3b30; }
        .swipe-content { position: relative; z-index: 10; transition: transform 0.3s ease; background: white; width: 100%; }
        .delete-btn { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
    </style>
</head>
<body class="flex w-screen">

    <aside id="sidebar" class="w-72 bg-white flex flex-col p-6 shrink-0 border-r border-gray-200">
        <div class="flex items-center justify-between mb-8 mt-4">
            <span class="text-2xl font-black">档案中心</span>
            <button onclick="toggleSidebar()"><i data-lucide="chevron-left"></i></button>
        </div>
        <div id="user-nav" class="flex-1 space-y-2 overflow-y-auto"></div>
        <button onclick="showAddUserModal()" class="mt-4 w-full py-4 bg-gray-900 text-white text-lg font-bold rounded-2xl shadow-lg active:scale-95 transition-all">+ 添加新成员</button>
    </aside>

    <main class="flex-1 relative bg-[#f2f2f7]">
        <header class="fixed top-0 left-0 right-0 flex items-center justify-between px-8 py-4 bg-white/80 backdrop-blur-md z-50">
            <div class="flex items-center gap-6">
                <button id="sidebar-open" onclick="toggleSidebar()" class="hidden p-3 bg-gray-100 rounded-2xl"><i data-lucide="menu"></i></button>
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">查看日期</span>
                    <input type="date" id="view-date" onchange="render()" class="font-bold text-xl bg-transparent p-0 w-auto">
                </div>
            </div>
            <button onclick="openManageModal()" class="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400"><i data-lucide="settings"></i></button>
        </header>

        <div id="main-scroll" class="px-6">
            <div id="empty-state" class="hidden flex flex-col items-center justify-center h-full text-gray-400">
                <i data-lucide="users" class="w-16 h-16 mb-4"></i>
                <p class="text-xl">点击左下角添加第一个成员</p>
            </div>

            <div id="content-area" class="max-w-5xl mx-auto space-y-8">
                <section class="card p-8">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-4 mb-3">
                                <h1 id="display-name" class="text-5xl font-black tracking-tighter">--</h1>
                                <div id="display-gender"></div>
                            </div>
                            <div class="flex gap-3">
                                <span class="bg-gray-100 px-4 py-1.5 rounded-full text-sm font-bold">目标 <b id="display-target">--</b> KG</span>
                                <span onclick="editWish()" class="bg-green-50 text-green-600 px-4 py-1.5 rounded-full text-sm font-bold cursor-pointer">愿望: <b id="display-wish">设置</b></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="weight-diff" class="text-6xl font-black text-[#34c759] tracking-tighter">0.0</div>
                            <p class="text-[10px] text-gray-300 font-bold mt-1 uppercase">KG TO GOAL</p>
                        </div>
                    </div>
                    <div id="display-mood" onclick="editMood()" class="bg-gray-50 p-5 rounded-2xl text-lg text-gray-500 italic">“ 点击记录感悟... ”</div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <span class="font-bold text-lg">体重轨迹</span>
                            <div id="w-range-btns" class="flex gap-1">
                                <button onclick="updateRange('weight', 7)" class="px-3 py-1 bg-gray-100 rounded-full text-xs">7D</button>
                                <button onclick="updateRange('weight', 30)" class="px-3 py-1 bg-gray-100 rounded-full text-xs">1M</button>
                            </div>
                        </div>
                        <div class="h-48"><canvas id="weightChart"></canvas></div>
                    </div>
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <span class="font-bold text-lg">血压心率</span>
                            <div id="bp-range-btns" class="flex gap-1">
                                <button onclick="updateRange('bp', 7)" class="px-3 py-1 bg-gray-100 rounded-full text-xs">7D</button>
                            </div>
                        </div>
                        <div class="h-48"><canvas id="bpChart"></canvas></div>
                    </div>
                </div>

                <section class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">坚持兴趣</h3>
                        <button onclick="addInterest()" class="text-[#34c759]"><i data-lucide="plus-circle"></i></button>
                    </div>
                    <div id="interest-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>

                <section class="card p-8 border-2 border-green-100">
                    <div class="flex gap-6 border-b mb-8 overflow-x-auto">
                        <button onclick="setLogType('weight')" id="tab-weight" class="pb-4 text-lg font-bold">测体重</button>
                        <button onclick="setLogType('bp')" id="tab-bp" class="pb-4 text-lg font-bold tab-active">量血压</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                        <div class="md:col-span-1"><input type="date" id="log-date"></div>
                        <div id="entry-form-fields" class="md:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                        <button onclick="submitEntry()" class="md:col-span-1 h-[48px] bg-[#34c759] text-white rounded-2xl font-bold">记录</button>
                    </div>
                </section>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-20">
                    <div id="list-food"></div><div id="list-sport"></div><div id="list-bp"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="add-user-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-md z-[200] flex items-center justify-center p-6">
        <div class="bg-white rounded-[32px] p-8 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-black mb-6">添加新成员档案</h2>
            <div class="space-y-4">
                <input type="text" id="new-u-name" placeholder="成员姓名" class="bg-gray-100">
                <select id="new-u-gender" class="bg-gray-100"><option value="female">女生</option><option value="male">男生</option></select>
                <input type="number" id="new-u-target" placeholder="目标体重 (KG)" class="bg-gray-100">
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="hideAddUserModal()" class="flex-1 py-4 text-gray-400 font-bold">取消</button>
                <button onclick="confirmAddUser()" class="flex-1 py-4 bg-green-500 text-white rounded-2xl font-bold">创建档案</button>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('health_ipad_final') || '[]');
        let curUid = localStorage.getItem('health_uid_final') || (users[0]?.id || null);
        let entryType = 'weight', charts = {}, ranges = { weight: 7, bp: 7 };

        function sync() {
            localStorage.setItem('health_ipad_final', JSON.stringify(users));
            if(curUid) localStorage.setItem('health_uid_final', curUid);
            render();
        }

        // 弹窗控制
        function showAddUserModal() { document.getElementById('add-user-modal').classList.remove('hidden'); }
        function hideAddUserModal() { document.getElementById('add-user-modal').classList.add('hidden'); }
        
        function confirmAddUser() {
            const name = document.getElementById('new-u-name').value;
            const target = document.getElementById('new-u-target').value || 60;
            const gender = document.getElementById('new-u-gender').value;
            if(!name) return alert("请输入姓名");
            
            const newUser = {
                id: Date.now(),
                name: name,
                target: parseFloat(target),
                gender: gender,
                weights: [], bps: [], logs: [], interests: [],
                wish: '', mood: ''
            };
            users.push(newUser);
            curUid = newUser.id;
            hideAddUserModal();
            sync();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-hidden');
            document.getElementById('sidebar-open').classList.toggle('hidden');
        }

        function render() {
            const uNav = document.getElementById('user-nav');
            if(users.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('content-area').classList.add('hidden');
                uNav.innerHTML = '';
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');

            uNav.innerHTML = users.map(u => `
                <div class="swipe-container">
                    <div class="delete-btn" onclick="deleteUser(${u.id})">注销</div>
                    <div onclick="curUid=${u.id};sync()" class="swipe-content p-4 font-bold ${curUid == u.id ? 'text-green-500 bg-white shadow-sm' : 'text-gray-400'}">
                        ${u.name}
                    </div>
                </div>`).join('');

            const u = users.find(x => x.id == curUid);
            if(!u) { if(users.length > 0) { curUid = users[0].id; render(); } return; }

            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-target').innerText = u.target;
            document.getElementById('display-wish').innerText = u.wish || '设置目标';
            document.getElementById('display-mood').innerText = u.mood || '“ 今日感悟... ”';
            document.getElementById('display-gender').innerHTML = u.gender === 'male' ? '<i data-lucide="mars" class="text-blue-500"></i>' : '<i data-lucide="venus" class="text-pink-500"></i>';

            // 计算差值
            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const curW = sortedW.length ? sortedW[sortedW.length-1].val : u.target;
            document.getElementById('weight-diff').innerText = (curW - u.target).toFixed(1);

            // 渲染兴趣
            document.getElementById('interest-list').innerHTML = (u.interests || []).map(i => `
                <div class="swipe-container"><div class="delete-btn" onclick="deleteInterest(${i.id})">删除</div>
                <div class="swipe-content p-4 flex justify-between items-center">
                    <span class="font-bold">${i.name}</span>
                    <button onclick="toggleInt(${i.id})" class="text-green-500"><i data-lucide="${i.paused?'play-circle':'pause-circle'}"></i></button>
                </div></div>`).join('');

            updateCharts(u);
            renderEntryFields();
            lucide.createIcons();
        }

        function renderEntryFields() {
            const container = document.getElementById('entry-form-fields');
            if(entryType === 'weight') {
                container.innerHTML = `<select id="e-slot"><option>早起</option><option>睡前</option></select><div class="md:col-span-2"><input type="number" id="e-val" placeholder="体重(KG)"></div>`;
            } else {
                container.innerHTML = `<select id="e-slot"><option>常规</option></select><input type="number" id="e-high" placeholder="高压"><input type="number" id="e-low" placeholder="低压">`;
            }
        }

        function setLogType(t) { entryType = t; render(); }

        function submitEntry() {
            const u = users.find(x => x.id == curUid);
            const date = document.getElementById('log-date').value;
            const ts = new Date(date).getTime();
            if(entryType === 'weight') {
                const val = document.getElementById('e-val').value;
                if(val) u.weights.push({id:Date.now(), val:parseFloat(val), date, ts});
            } else {
                const h = document.getElementById('e-high').value;
                const l = document.getElementById('e-low').value;
                if(h && l) u.bps.push({id:Date.now(), high:parseInt(h), low:parseInt(l), date, ts, hr:75});
            }
            sync();
        }

        function updateCharts(u) {
            const filter = (arr, d) => arr.filter(i => i.ts >= Date.now() - d*86400000).sort((a,b)=>a.ts-b.ts);
            const wd = filter(u.weights, ranges.weight);
            if(charts.w) charts.w.destroy();
            charts.w = new Chart(document.getElementById('weightChart'), {
                type: 'line', data: { labels: wd.map(d=>d.date.slice(5)), datasets: [{data: wd.map(d=>d.val), borderColor: '#34c759', tension: 0.4}] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function deleteUser(id) { if(confirm("确定注销该成员？数据将永久消失")) { users = users.filter(u=>u.id!==id); sync(); } }
        function editMood() { const m = prompt("记录心情:"); if(m) { users.find(x=>x.id==curUid).mood = m; sync(); } }
        function addInterest() { const n = prompt("项目名称:"); if(n) { users.find(x=>x.id==curUid).interests.push({id:Date.now(), name:n, paused:false}); sync(); } }

        // 滑动删除交互补全
        let tStart = 0, currentSwipeEl = null;
        document.addEventListener('touchstart', e => {
            const content = e.target.closest('.swipe-content');
            if (content) {
                document.querySelectorAll('.swipe-content').forEach(el => el.style.transform = 'translateX(0)');
                tStart = e.touches[0].clientX;
                currentSwipeEl = content;
            }
        });
        document.addEventListener('touchmove', e => {
            if (!currentSwipeEl) return;
            let diff = e.touches[0].clientX - tStart;
            if (diff < -10) currentSwipeEl.style.transform = `translateX(${Math.max(diff, -80)}px)`;
        });
        document.addEventListener('touchend', e => {
            if (!currentSwipeEl) return;
            let diff = e.changedTouches[0].clientX - tStart;
            currentSwipeEl.style.transform = diff < -40 ? `translateX(-80px)` : `translateX(0)`;
            currentSwipeEl = null;
        });

        window.onload = () => {
            document.getElementById('view-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('log-date').value = new Date().toISOString().split('T')[0];
            sync();
        };
    </script>
</body>
</html>
