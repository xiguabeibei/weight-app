<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¹»å½©ç”œå¿ƒå¥èº«æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;900&display=swap');
        
        :root { --p-deep: #ff4d6d; --p-light: #ff85a1; --p-soft: #ffccd5; }

        body { 
            background: linear-gradient(45deg, #fff0f3, #ffccd5, #fff0f3);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #c9184a;
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
            perspective: 1000px;
        }

        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        /* æµ®å¤¸èƒŒæ™¯æ¨±èŠ± */
        .sakura { position: fixed; top: -10%; z-index: -1; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        /* å‘¼å¸å¡ç‰‡ */
        .floating-card {
            background: rgba(255, 255, 255, 0.75);
            border: 3px solid white;
            backdrop-filter: blur(15px);
            border-radius: 2.5rem;
            box-shadow: 0 15px 35px rgba(255, 77, 109, 0.15);
            animation: float 6s ease-in-out infinite;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .floating-card:hover { transform: scale(1.02) rotateX(2deg); box-shadow: 0 20px 45px rgba(255, 77, 109, 0.25); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ç‚«å½©è¿›åº¦æ¡ */
        .glow-bar {
            position: relative;
            background: linear-gradient(90deg, #ff85a1, #ff4d6d, #ff85a1);
            background-size: 200% auto;
            animation: moveGradient 2s linear infinite;
            box-shadow: 0 0 15px rgba(255, 77, 109, 0.5);
        }
        @keyframes moveGradient { to { background-position: 200% center; } }

        /* æ»‘åŠ¨åˆ é™¤ï¼šå¼ºåˆ¶èƒŒæ™¯éš”ç¦» */
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-x; border-radius: 1.5rem; margin-bottom: 1rem; background: #ff4d6d !important; }
        .swipe-content { position: relative; z-index: 20; transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); background: white !important; width: 100%; border: 2px solid transparent; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; color: white; display: flex; align-items: center; justify-content: center; z-index: 10; font-weight: 900; }

        .btn-pop { background: #ff4d6d; color: white; transition: all 0.2s; }
        .btn-pop:active { transform: scale(0.85); filter: hue-rotate(20deg); }

        .sidebar-active { background: #ff4d6d !important; color: white !important; transform: translateX(10px) scale(1.05); box-shadow: -5px 5px 15px rgba(255, 77, 109, 0.3); }

        /* å„ç§æ–‡å­—ç‰¹æ•ˆ */
        .text-pop { font-family: 'ZCOOL KuaiLe', cursive; }
        .num-jump { display: inline-block; animation: jump 0.5s ease; }
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen p-4 gap-6">

    <div id="sakura-container"></div>

    <aside class="w-72 flex flex-col p-6 floating-card">
        <div class="flex flex-col items-center gap-2 mb-10">
            <div class="w-16 h-16 rounded-3xl btn-pop flex items-center justify-center shadow-2xl rotate-12"><i data-lucide="heart" class="w-8 h-8 fill-current"></i></div>
            <h1 class="text-pop text-2xl mt-2 tracking-widest">ç”œå¿ƒå®éªŒå®¤</h1>
        </div>
        <nav id="user-nav" class="flex-1 space-y-3 overflow-y-auto no-scrollbar px-2"></nav>
        <div class="pt-6 border-t-2 border-dashed border-pink-200 space-y-3">
            <button onclick="addUser()" class="btn-pop w-full p-4 rounded-2xl flex items-center justify-center gap-3 font-black"><i data-lucide="user-plus"></i> å¬å”¤æ–°æˆå‘˜</button>
            <button onclick="openManageModal()" class="w-full p-4 rounded-2xl text-pink-400 font-bold hover:bg-white flex items-center justify-center gap-3 transition-all"><i data-lucide="settings"></i> æˆå‘˜æ¡£æ¡ˆ</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar space-y-8 pb-10">
        
        <section class="floating-card p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-pop text-lg flex items-center gap-2">ğŸ’– å‡é‡è¿›åŒ–è®°å½•</h3>
                <div class="bg-pink-100 px-4 py-1 rounded-full text-xs font-black" id="progress-percent">0%</div>
            </div>
            <div class="relative w-full h-8 bg-pink-100 rounded-full p-1.5 overflow-hidden">
                <div id="progress-bar" class="glow-bar h-full rounded-full w-0 transition-all duration-1000"></div>
                <div class="absolute inset-0 flex justify-center items-center text-[10px] font-black mix-blend-overlay uppercase tracking-tighter">Evolution Progress</div>
            </div>
            <div class="grid grid-cols-2 mt-4">
                <div class="text-left"><p class="text-[10px] opacity-50 font-black">STARTING POINT</p><p class="text-xl font-black text-pink-400" id="start-w">-- KG</p></div>
                <div class="text-right"><p class="text-[10px] opacity-50 font-black">GOAL TARGET</p><p class="text-xl font-black text-pink-600" id="target-w">-- KG</p></div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section class="lg:col-span-2 floating-card p-10 relative overflow-hidden group">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-pink-100 rounded-full opacity-30 group-hover:scale-150 transition-all duration-700"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="flex items-center gap-6 mb-4">
                            <h2 id="display-name" class="text-pop text-6xl tracking-tighter">--</h2>
                            <div id="display-gender-icon" class="animate-bounce"></div>
                        </div>
                        <div class="inline-block bg-pink-500 text-white px-4 py-1 rounded-lg text-xs font-black shadow-lg" id="display-wish">--</div>
                    </div>
                    <div class="text-right">
                        <div id="status-tag" class="text-7xl text-pop leading-none">0.0</div>
                        <p class="text-xs font-black opacity-30 mt-2 italic tracking-widest">SURPLUS WEIGHT</p>
                    </div>
                </div>
                <div id="mood-display" class="mt-8 p-5 rounded-3xl bg-white/80 border-2 border-dashed border-pink-200 text-sm font-bold italic shadow-inner">âœ¨ æ¯æ—¥çŠ¶æ€: --</div>
            </section>

            <section class="floating-card p-8 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="text-pop text-lg flex items-center gap-2"><i data-lucide="flame" class="text-orange-400"></i> çƒ­è¡€ä¹ æƒ¯</h4>
                    <button onclick="addInterest()" class="btn-pop w-10 h-10 rounded-full flex items-center justify-center shadow-xl"><i data-lucide="plus"></i></button>
                </div>
                <div id="interest-list" class="space-y-4 overflow-y-auto no-scrollbar flex-1"></div>
            </section>
        </div>

        <section class="floating-card p-8">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-pop text-xl flex items-center gap-2"><i data-lucide="activity"></i> ä½“é‡èƒ½é‡è°±å›¾</h3>
                <div class="flex gap-3">
                    <input type="date" id="chart-start" onchange="renderChart()" class="text-xs p-2 rounded-xl">
                    <input type="date" id="chart-end" onchange="renderChart()" class="text-xs p-2 rounded-xl">
                </div>
            </div>
            <div class="h-80 w-full"><canvas id="weightChart"></canvas></div>
        </section>

        <section class="floating-card p-8">
            <div class="flex flex-wrap items-center justify-between gap-6 mb-8">
                <div class="flex items-center gap-4 bg-white p-3 rounded-2xl shadow-inner border-2 border-pink-100">
                    <i data-lucide="calendar" class="text-pink-500"></i>
                    <input type="date" id="global-date" onchange="render()" class="font-black text-xl text-pink-500 bg-transparent border-none">
                </div>
                <div class="flex gap-2 p-2 bg-pink-100 rounded-3xl">
                    <button onclick="setLogType('weight')" id="tab-weight" class="px-8 py-3 rounded-2xl font-black text-xs transition-all">ç§¤ä½“é‡</button>
                    <button onclick="setLogType('food')" id="tab-food" class="px-8 py-3 rounded-2xl font-black text-xs transition-all">èƒ½é‡è¡¥ç»™</button>
                    <button onclick="setLogType('sport')" id="tab-sport" class="px-8 py-3 rounded-2xl font-black text-xs transition-all">å¡è·¯é‡Œç‡ƒçƒ§</button>
                </div>
            </div>
            <div id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 pb-20">
            <div id="list-food"></div>
            <div id="list-sport"></div>
        </div>
    </main>

    <div id="manage-modal" class="hidden fixed inset-0 bg-pink-500/30 backdrop-blur-2xl z-50 flex items-center justify-center p-6">
        <div class="floating-card p-12 w-full max-w-2xl bg-white/95 border-pink-400">
            <h2 class="text-pop text-3xl mb-10 flex items-center gap-4"><i data-lucide="heart-pulse" class="animate-pulse text-pink-500"></i> ä¿®æ”¹ DNA æ¡£æ¡ˆ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-2"><label class="text-xs font-black opacity-50 ml-4">ä»£å·åç§°</label><input type="text" id="m-name" class="w-full p-5 rounded-2xl shadow-inner"></div>
                <div class="space-y-2"><label class="text-xs font-black opacity-50 ml-4">æ€§åˆ«é€‰æ‹©</label><select id="m-gender" class="w-full p-5 rounded-2xl shadow-inner"><option value="female">ç¾å°‘å¥³</option><option value="male">å¸…æ°”ç”·å­©</option></select></div>
                <div class="space-y-2"><label class="text-xs font-black opacity-50 ml-4">ç©¶æç›®æ ‡ä½“é‡ (KG)</label><input type="number" id="m-target" class="w-full p-5 rounded-2xl shadow-inner"></div>
                <div class="space-y-2"><label class="text-xs font-black opacity-50 ml-4">å¿ƒä¸­æ‰€æ„¿</label><input type="text" id="m-wish" class="w-full p-5 rounded-2xl shadow-inner"></div>
                <div class="space-y-2 md:col-span-2"><label class="text-xs font-black opacity-50 ml-4">ä»Šæ—¥è§‰æ‚Ÿ</label><textarea id="m-mood" class="w-full p-5 rounded-2xl shadow-inner h-24"></textarea></div>
            </div>
            <div class="flex gap-6 mt-12">
                <button onclick="closeManageModal()" class="flex-1 font-black opacity-40 hover:opacity-100 transition-all">æ’¤é€€</button>
                <button onclick="saveUserManage()" class="flex-1 p-6 btn-pop rounded-3xl text-lg font-black shadow-2xl">ç¡® è®¤ è§‰ é†’</button>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('sf_ultra_v1') || '[]');
        let curUid = localStorage.getItem('sf_ultra_uid') || (users[0]?.id || null);
        let entryType = 'weight', chart = null;

        // æµ®å¤¸èƒŒæ™¯æ¨±èŠ±ç”Ÿæˆ
        function createSakura() {
            const container = document.getElementById('sakura-container');
            const petal = document.createElement('div');
            petal.className = 'sakura';
            petal.style.left = Math.random() * 100 + 'vw';
            petal.style.width = petal.style.height = Math.random() * 15 + 10 + 'px';
            petal.style.backgroundColor = ['#ffccd5','#ffb3c1','#ff85a1'][Math.floor(Math.random()*3)];
            petal.style.borderRadius = '50% 0 50% 50%';
            petal.style.animationDuration = Math.random() * 5 + 5 + 's';
            container.appendChild(petal);
            setTimeout(() => petal.remove(), 10000);
        }
        setInterval(createSakura, 500);

        // æ ¸å¿ƒåŒæ­¥ä¸é€»è¾‘
        function sync() {
            localStorage.setItem('sf_ultra_v1', JSON.stringify(users));
            if(curUid) localStorage.setItem('sf_ultra_uid', curUid);
            render();
        }

        // æ»‘åŠ¨åˆ é™¤äº¤äº’
        let tStart = 0, currentSwipeEl = null;
        document.addEventListener('touchstart', e => {
            const container = e.target.closest('.swipe-container');
            if (container) {
                document.querySelectorAll('.swipe-content').forEach(el => { if(el !== container.querySelector('.swipe-content')) el.style.transform = 'translateX(0)'; });
                tStart = e.touches[0].clientX;
                currentSwipeEl = container.querySelector('.swipe-content');
            }
        });
        document.addEventListener('touchmove', e => {
            if (!currentSwipeEl) return;
            const diff = e.touches[0].clientX - tStart;
            if (diff < 0) currentSwipeEl.style.transform = `translateX(${Math.max(diff, -80)}px)`;
            else currentSwipeEl.style.transform = `translateX(0)`;
        });
        document.addEventListener('touchend', e => {
            if (!currentSwipeEl) return;
            const diff = e.changedTouches[0].clientX - tStart;
            currentSwipeEl.style.transform = diff < -40 ? `translateX(-80px)` : `translateX(0)`;
            currentSwipeEl = null;
        });

        function addUser() {
            const name = prompt("è¾“å…¥ç¥ç§˜ä»£å·:"); if(!name) return;
            const u = { id: Date.now(), name, target: 50, gender: 'female', weights: [], logs: [], interests: [] };
            users.push(u); curUid = u.id; sync();
        }

        function deleteItem(id, listType) {
            const u = users.find(x => x.id == curUid);
            if(listType === 'user') { users = users.filter(u => u.id !== id); curUid = users[0]?.id || null; }
            else if(listType === 'interest') u.interests = u.interests.filter(i => i.id !== id);
            else u.logs = u.logs.filter(l => l.id !== id);
            sync();
        }

        function toggleInterest(id) {
            const u = users.find(x => x.id == curUid);
            const i = u.interests.find(i => i.id === id);
            i.paused = !i.paused;
            sync();
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const date = document.getElementById('global-date').value;
            const slot = document.getElementById('e-slot').value;

            if (entryType === 'weight') {
                const val = parseFloat(document.getElementById('e-val').value);
                if (!val) return;
                const idx = u.weights.findIndex(w => w.date === date && w.slot === slot);
                if (idx > -1) {
                    if (confirm(`è¯¥æ—¶æ®µå·²æœ‰è®°å½• ${u.weights[idx].val}KGï¼Œè¦æ”¹å†™å—ï¼Ÿ`)) u.weights[idx].val = val;
                } else {
                    u.weights.push({ id: Date.now(), val, slot, date, ts: new Date(date).getTime() });
                }
            } else {
                const name = document.getElementById('e-name').value, cal = parseInt(document.getElementById('e-cal').value);
                if (!name || isNaN(cal)) return;
                const idx = u.logs.findIndex(l => l.date === date && l.name === name && l.type === entryType);
                if (idx > -1) {
                    if (confirm(`å·²æœ‰åŒåè®°å½•ï¼Œè¦æ›´æ–°å¡è·¯é‡Œå—ï¼Ÿ`)) u.logs[idx].cal = cal;
                } else {
                    u.logs.unshift({ id: Date.now(), type: entryType, name, cal, slot, date });
                }
            }
            sync();
        }

        function render() {
            const uNav = document.getElementById('user-nav');
            uNav.innerHTML = users.map(u => `
                <div class="swipe-container shadow-lg">
                    <div class="delete-action" onclick="deleteItem(${u.id}, 'user')"><i data-lucide="trash-2"></i></div>
                    <div onclick="curUid=${u.id};sync()" class="swipe-content p-5 cursor-pointer flex items-center gap-4 ${curUid == u.id ? 'sidebar-active' : 'text-pink-400'}">
                        <div class="w-2 h-2 rounded-full ${curUid == u.id ? 'bg-white' : 'bg-pink-200'}"></div>
                        <span class="font-black text-sm flex-1 uppercase">${u.name}</span>
                        <i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-4 h-4 opacity-30"></i>
                    </div>
                </div>`).join('');
            
            const u = users.find(x => x.id == curUid); 
            if(!u) {
                document.querySelector('main').classList.add('opacity-0');
                return;
            } else {
                document.querySelector('main').classList.remove('opacity-0');
            }

            // è¿›åº¦æ¡è®¡ç®—ï¼ˆå„æˆå‘˜æ•°æ®ç‹¬ç«‹ï¼‰
            const sortedWeights = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const startW = sortedWeights.length > 0 ? sortedWeights[0].val : u.target + 10;
            const curW = sortedWeights.length > 0 ? sortedWeights[sortedWeights.length-1].val : startW;
            const targetW = u.target;
            
            let progress = 0;
            if(startW > targetW) progress = Math.max(0, Math.min(100, ((startW - curW) / (startW - targetW)) * 100));
            else progress = curW <= targetW ? 100 : 0;

            document.getElementById('progress-bar').style.width = progress + '%';
            const pText = document.getElementById('progress-percent');
            pText.innerText = Math.round(progress) + '%';
            pText.classList.add('num-jump'); setTimeout(()=>pText.classList.remove('num-jump'), 500);

            document.getElementById('start-w').innerText = startW + ' KG';
            document.getElementById('target-w').innerText = targetW + ' KG';
            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-wish').innerText = 'æ„¿æœ›ï¼š' + (u.wish || 'æš‚æ— æ„¿æœ›');
            document.getElementById('mood-display').innerText = `âœ¨ æ¯æ—¥è§‰æ‚Ÿ: ${u.mood || 'èº«ä½“å¥åº·ï¼Œä¸‡äº‹å¦‚æ„'}`;
            document.getElementById('display-gender-icon').innerHTML = `<i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-10 h-10 ${u.gender==='male'?'text-blue-500':'text-pink-500'}"></i>`;
            
            const diff = (curW - targetW).toFixed(1);
            const tagEl = document.getElementById('status-tag');
            tagEl.innerText = (diff > 0 ? "+" : "") + diff;
            tagEl.classList.add('num-jump'); setTimeout(()=>tagEl.classList.remove('num-jump'), 500);

            // å…´è¶£ä¹ æƒ¯
            document.getElementById('interest-list').innerHTML = (u.interests || []).map(i => {
                const days = Math.floor((Date.now() - i.start) / 86400000) + 1;
                return `
                <div class="swipe-container shadow-md">
                    <div class="delete-action" onclick="deleteItem(${i.id}, 'interest')">åˆ é™¤</div>
                    <div class="swipe-content p-5 border-2 border-pink-100 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full btn-pop flex items-center justify-center ${i.paused ? 'grayscale' : 'animate-spin-slow'}">
                            <i data-lucide="${i.paused ? 'pause' : 'zap'}" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-sm">${i.name}</div>
                            <div class="text-[10px] opacity-40 font-black">å·²åšæŒ ${days} å¤© ${i.paused ? '(æš‚åœä¸­)' : ''}</div>
                        </div>
                        <button onclick="toggleInterest(${i.id})" class="text-pink-300 hover:text-pink-500 transition-colors">
                            <i data-lucide="${i.paused ? 'play' : 'square'}" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');

            // æµæ°´
            const gDate = document.getElementById('global-date').value;
            const logs = u.logs.filter(l => l.date === gDate);
            const logTpl = (l, color) => `
                <div class="swipe-container shadow-sm">
                    <div class="delete-action" onclick="deleteItem(${l.id}, 'log')">åˆ é™¤</div>
                    <div class="swipe-content p-4 border-2 border-pink-50 flex justify-between items-center group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-${color}-100 flex items-center justify-center text-${color}-500 group-hover:rotate-12 transition-transform">
                                <i data-lucide="${l.type==='food'?'coffee':'flame'}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-sm">${l.name}</div>
                                <div class="text-[9px] font-black opacity-30">${l.slot}</div>
                            </div>
                        </div>
                        <div class="text-right font-black text-${color}-500">${l.cal} KCAL</div>
                    </div>
                </div>`;
            
            document.getElementById('list-food').innerHTML = `<h4 class="text-pop text-pink-500 mb-4 ml-2">ğŸ­ èƒ½é‡è¡¥ç»™æ¸…å•</h4>` + logs.filter(l=>l.type==='food').map(l=>logTpl(l, 'pink')).join('');
            document.getElementById('list-sport').innerHTML = `<h4 class="text-pop text-blue-500 mb-4 ml-2">ğŸ”¥ è„‚è‚ªç‡ƒçƒ§æŠ¥å‘Š</h4>` + logs.filter(l=>l.type==='sport').map(l=>logTpl(l, 'blue')).join('');

            renderEntryForm(); renderChart(); lucide.createIcons();
        }

        function setLogType(t) { entryType = t; renderEntryForm(); }
        function renderEntryForm() {
            const container = document.getElementById('entry-form');
            ['weight', 'food', 'sport'].forEach(t => {
                const btn = document.getElementById('tab-'+t);
                btn.className = entryType === t ? "px-8 py-3 rounded-2xl font-black text-xs bg-pink-500 text-white shadow-xl scale-110" : "px-8 py-3 rounded-2xl font-black text-xs text-pink-300";
            });

            if(entryType === 'weight') {
                container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl shadow-inner font-black text-xs"><option value="æ™¨é—´">æ—©æ™¨ç§°é‡</option><option value="æ™šé—´">ç¡å‰ç§°é‡</option></select><input type="number" id="e-val" step="0.1" placeholder="ä»Šæ—¥ä½“é‡(KG)" class="p-4 rounded-2xl shadow-inner font-black md:col-span-2 text-xs"><button onclick="submitEntry()" class="btn-pop p-4 rounded-2xl font-black text-xs">è®°å½•èƒ½é‡</button>`;
            } else {
                const slots = entryType === 'food' ? ["æ—©é¤","åˆé¤","æ™šé¤","æ·±å¤œé£Ÿå ‚"] : ["æœ‰æ°§è¿åŠ¨","æ— æ°§æ’¸é“","æ‹‰ä¼¸ä¿®æ•´"];
                container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl shadow-inner font-black text-xs">${slots.map(s=>`<option value="${s}">${s}</option>`).join('')}</select><input type="text" id="e-name" placeholder="å…·ä½“åç§°" class="p-4 rounded-2xl shadow-inner font-black text-xs"><input type="number" id="e-cal" placeholder="å¡è·¯é‡Œ" class="p-4 rounded-2xl shadow-inner font-black text-xs"><button onclick="submitEntry()" class="btn-pop p-4 rounded-2xl font-black text-xs">ç¡®è®¤æ·»åŠ </button>`;
            }
        }

        function renderChart() {
            const u = users.find(x => x.id == curUid); if(!u || !u.weights.length) return;
            const ctx = document.getElementById('weightChart').getContext('2d');
            if(chart) chart.destroy();
            const sorted = [...u.weights].sort((a,b)=>a.ts-b.ts);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(x => x.date.slice(5) + ' ' + x.slot),
                    datasets: [{ 
                        data: sorted.map(x=>x.val), 
                        borderColor: '#ff4d6d', borderWidth: 6, tension: 0.4, fill: true,
                        pointRadius: 6, pointHoverRadius: 10, pointBackgroundColor: '#fff',
                        backgroundColor: (context) => {
                            const g = ctx.createLinearGradient(0, 0, 0, 400);
                            g.addColorStop(0, 'rgba(255, 77, 109, 0.3)');
                            g.addColorStop(1, 'rgba(255, 77, 109, 0)');
                            return g;
                        }
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { tooltip: { backgroundColor: '#ff4d6d', padding: 15, titleFont: { size: 14 } }, legend: { display: false } },
                    scales: { 
                        y: { border: { display: false }, grid: { color: 'rgba(255, 77, 109, 0.1)' }, ticks: { color: '#ff4d6d', font: { weight: 'bold' } } },
                        x: { border: { display: false }, grid: { display: false }, ticks: { color: '#ff4d6d', font: { size: 10 } } }
                    }
                }
            });
        }

        function addInterest() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const name = prompt("è¾“å…¥è¦å¼€å¯çš„çƒ­è¡€ä¹ æƒ¯ï¼š");
            if(name) { u.interests.push({ id: Date.now(), name, start: Date.now(), paused: false }); sync(); }
        }

        function openManageModal() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            document.getElementById('m-name').value = u.name;
            document.getElementById('m-gender').value = u.gender;
            document.getElementById('m-target').value = u.target;
            document.getElementById('m-wish').value = u.wish || '';
            document.getElementById('m-mood').value = u.mood || '';
            document.getElementById('manage-modal').classList.remove('hidden');
        }
        function closeManageModal() { document.getElementById('manage-modal').classList.add('hidden'); }
        function saveUserManage() {
            const u = users.find(x => x.id == curUid);
            u.name = document.getElementById('m-name').value; 
            u.gender = document.getElementById('m-gender').value;
            u.target = parseFloat(document.getElementById('m-target').value);
            u.wish = document.getElementById('m-wish').value; 
            u.mood = document.getElementById('m-mood').value;
            closeManageModal(); sync();
        }

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('global-date').value = today;
            document.getElementById('chart-end').value = today;
            document.getElementById('chart-start').value = new Date(Date.now() - 30*86400000).toISOString().split('T')[0];
            sync(); 
        };
    </script>
</body>
</html>
