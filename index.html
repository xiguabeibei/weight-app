<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>å®¶åº­å¥åº·è®°å½•</title>

<style>
:root{
 --bg:#f6f7fb;--card:#fff;--text:#222;
 --primary:#ff8fb1;--accent:#a78bfa;
}
body.dark{
 --bg:#1e1e2f;--card:#2b2b3c;--text:#f4f4f5;
}
body{
 margin:0;display:flex;height:100vh;
 font-family:-apple-system,"PingFang SC";
 background:var(--bg);color:var(--text);
}
aside{
 width:260px;background:var(--card);
 padding:16px;box-shadow:4px 0 20px rgba(0,0,0,.08);
}
aside h3{margin-top:0}
aside button,aside select{
 width:100%;padding:10px;margin-bottom:8px;
 border:none;border-radius:12px;
}
.member strong{display:block;margin-top:10px}
.member div{
 padding:6px 10px;border-radius:10px;
 cursor:pointer;
}
.member div:hover{background:#eee}
main{flex:1;padding:20px;overflow:auto}
.card{
 background:var(--card);border-radius:20px;
 padding:16px;margin-bottom:16px;
 box-shadow:0 10px 30px rgba(0,0,0,.1);
}
input,textarea{
 width:100%;padding:12px;margin-bottom:10px;
 border-radius:12px;border:1px solid #ccc;
}
.primary{
 width:100%;padding:12px;border:none;
 border-radius:999px;color:#fff;
 background:linear-gradient(135deg,var(--primary),var(--accent));
}
canvas{width:100%;height:220px}
.progress{height:14px;background:#ddd;border-radius:999px}
.progress div{
 height:100%;background:linear-gradient(135deg,#67e8f9,#a78bfa);
}
.tip{color:var(--primary);margin-top:8px}
</style>
</head>

<body>

<aside>
<h3>è®¾ç½®</h3>
<button onclick="openSettings()">æ·»åŠ æˆå‘˜</button>
<select onchange="setTheme(this.value)">
 <option value="system">è·Ÿéšç³»ç»Ÿ</option>
 <option value="light">æ—¥é—´æ¨¡å¼</option>
 <option value="dark">å¤œé—´æ¨¡å¼</option>
</select>

<h3>æˆå‘˜ä¿¡æ¯</h3>
<div id="members"></div>
</aside>

<main><div id="content"></div></main>

<script>
/* ========= åŸºç¡€ ========= */
let store=JSON.parse(localStorage.getItem("healthStore")||"{}");
let currentUser=null;
let page="weight";
let timeType="pm";
let range=7;

function save(){
 localStorage.setItem("healthStore",JSON.stringify(store));
}

/* ========= ä¸»é¢˜ ========= */
function setTheme(t){
 localStorage.setItem("theme",t);applyTheme();
}
function applyTheme(){
 const t=localStorage.getItem("theme")||"system";
 document.body.classList.toggle("dark",
  t==="dark"||(t==="system"&&matchMedia("(prefers-color-scheme:dark)").matches)
 );
}
applyTheme();

/* ========= æˆå‘˜ ========= */
function renderMembers(){
 members.innerHTML="";
 Object.keys(store).forEach(n=>{
  const d=document.createElement("div");
  d.className="member";
  d.innerHTML=`
   <strong>${n}</strong>
   <div onclick="open('${n}','weight')">ä½“é‡è®°å½•</div>
   <div onclick="open('${n}','food')">é¥®é£Ÿæ‘„å…¥</div>
   <div onclick="open('${n}','sport')">è¿åŠ¨å‡è„‚</div>`;
  members.appendChild(d);
 });
}
renderMembers();

function open(name,p){currentUser=name;page=p;render();}
function openSettings(){page="settings";render();}

/* ========= æ¸²æŸ“ ========= */
function render(){
 if(page==="settings"){
  content.innerHTML=`
   <div class="card">
    <h2>æ·»åŠ æˆå‘˜</h2>
    <input id="n" placeholder="æˆå‘˜å">
    <input id="s" placeholder="åˆå§‹ä½“é‡">
    <input id="t" placeholder="ç›®æ ‡ä½“é‡">
    <button class="primary" onclick="addMember()">ä¿å­˜</button>
   </div>`;return;
 }
 if(!currentUser){
  content.innerHTML="<div class='card'>è¯·å…ˆæ·»åŠ æˆå‘˜</div>";return;
 }
 const p=store[currentUser].profile;
 content.innerHTML=`
 <div class="card">
  <h2>${currentUser}</h2>
  <div>åˆå§‹ ${p.start}kg â†’ ç›®æ ‡ ${p.target}kg</div>
  <div class="progress"><div style="width:${progress()}%"></div></div>
  <div class="tip">${tip()}</div>
 </div>
 ${page==="weight"?weightUI():""}
 ${page==="food"?foodUI():""}
 ${page==="sport"?sportUI():""}
 `;
 if(page==="weight")drawWeight();
}

/* ========= æ•°æ®åˆå§‹åŒ– ========= */
function ensure(date){
 store[currentUser].records=store[currentUser].records||{};
 if(!store[currentUser].records[date]){
  store[currentUser].records[date]={
   am:{},pm:{},
   foods:[],foodTotal:0,
   sports:[],sportTotal:0
  };
 }
}

/* ========= æˆå‘˜ ========= */
function addMember(){
 const name=n.value;
 if(!name)return;
 store[name]={profile:{start:+s.value,target:+t.value},records:{}};
 save();renderMembers();open(name,"weight");
}

/* ========= ä½“é‡ ========= */
function weightUI(){
 const d=new Date().toISOString().slice(0,10);
 return `
 <div class="card">
  <input type="date" id="date" value="${d}">
  <button onclick="timeType='am'">æ—©</button>
  <button onclick="timeType='pm'">æ™š</button>
  <input id="w" placeholder="ä½“é‡ kg">
  <button class="primary" onclick="saveWeight()">ä¿å­˜ä½“é‡</button>
  <select onchange="range=this.value;drawWeight()">
   <option value="7">7å¤©</option><option value="30">1æœˆ</option>
   <option value="90">3æœˆ</option><option value="180">åŠå¹´</option>
   <option value="365">1å¹´</option>
  </select>
  <canvas id="wc" width="300" height="220"></canvas>
 </div>`;
}

function saveWeight(){
 const d=date.value;
 ensure(d);
 store[currentUser].records[d][timeType].weight=+w.value;
 save();render();
}

function drawWeight(){
 const ctx=wc.getContext("2d");
 ctx.clearRect(0,0,300,220);
 const rec=Object.values(store[currentUser].records)
  .map(r=>r.pm.weight).filter(v=>v);
 if(!rec.length)return;
 ctx.beginPath();
 rec.forEach((v,i)=>{
  const x=i*(300/(rec.length-1||1));
  const y=200-(v/Math.max(...rec))*160;
  i?ctx.lineTo(x,y):ctx.moveTo(x,y);
 });
 ctx.strokeStyle="#ff8fb1";ctx.lineWidth=3;ctx.stroke();
}

/* ========= é¥®é£Ÿ ========= */
function foodUI(){
 return `
 <div class="card">
  <textarea id="food" placeholder="é£Ÿç‰©å"></textarea>
  <input id="kcal" placeholder="å¡è·¯é‡Œ">
  <button class="primary" onclick="addFood()">æ·»åŠ é¥®é£Ÿ</button>
 </div>`;
}
function addFood(){
 const d=new Date().toISOString().slice(0,10);
 ensure(d);
 store[currentUser].records[d].foods.push({name:food.value,kcal:+kcal.value});
 store[currentUser].records[d].foodTotal+=+kcal.value;
 save();render();
}

/* ========= è¿åŠ¨ ========= */
function sportUI(){
 return `
 <div class="card">
  <input id="sport" placeholder="è¿åŠ¨ç±»å‹">
  <input id="burn" placeholder="æ¶ˆè€—å¡è·¯é‡Œ">
  <button class="primary" onclick="addSport()">æ·»åŠ è¿åŠ¨</button>
 </div>`;
}
function addSport(){
 const d=new Date().toISOString().slice(0,10);
 ensure(d);
 store[currentUser].records[d].sports.push({name:sport.value,kcal:+burn.value});
 store[currentUser].records[d].sportTotal+=+burn.value;
 save();render();
}

/* ========= æ¿€åŠ± ========= */
function progress(){
 const p=store[currentUser].profile;
 const rec=Object.values(store[currentUser].records);
 if(!rec.length)return 0;
 const last=rec.at(-1).pm.weight;
 return Math.min(100,(p.start-last)/(p.start-p.target)*100);
}
function tip(){
 const p=store[currentUser].profile;
 const rec=Object.values(store[currentUser].records);
 if(!rec.length)return "ä»ä»Šå¤©å¼€å§‹è®°å½•å§ ğŸŒ±";
 const last=rec.at(-1).pm.weight;
 const d=(last-p.target).toFixed(1);
 return d>0?`è·ç¦»ç›®æ ‡è¿˜æœ‰ ${d}kgï¼ŒåŠ æ²¹ ğŸ’ª`:"ç›®æ ‡è¾¾æˆ ğŸ‰";
}
</script>

</body>
</html>
