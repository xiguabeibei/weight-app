<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的健康日记</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 极简画风，类似微信 */
        body { font-family: sans-serif; background: #f7f7f7; margin: 0; padding: 20px; color: #333; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2 { font-size: 24px; margin: 0 0 15px 0; font-weight: bold; }
        
        /* 记录模块 */
        .input-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; flex: 1; min-width: 120px; }
        button.save-btn { background: #07c160; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* 图表控制 */
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-group button { background: #eee; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; margin-left: 5px; cursor: pointer; }
        .btn-group button.active { background: #07c160; color: white; }
        .chart-container { height: 250px; width: 100%; }

        /* 列表展示 */
        .list-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border: none; }
        .item-info { font-size: 16px; }
        .item-date { font-size: 12px; color: #999; }
        .del-btn { color: #ff4d4f; font-size: 14px; margin-left: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card">
        <h2 id="userName">我的健康看板</h2>
        <div style="font-size: 18px; color: #666;">
            当前体重：<span id="curW" style="color:#07c160; font-weight:bold;">--</span> KG 
            (目标: <span id="tarW">60</span> KG)
        </div>
    </div>

    <div class="card">
        <h2>记录数据</h2>
        <div class="input-group">
            <input type="date" id="recDate">
            <select id="recSlot"><option>早起</option><option>睡前</option></select>
        </div>
        <div class="input-group">
            <input type="number" id="recWeight" placeholder="体重(kg)">
            <input type="number" id="recHigh" placeholder="高压(收缩)">
            <input type="number" id="recLow" placeholder="低压(舒张)">
            <input type="number" id="recHR" placeholder="心率(bpm)">
        </div>
        <button class="save-btn" onclick="saveData()">保存记录</button>
    </div>

    <div class="card">
        <div class="chart-header">
            <b>体重曲线</b>
            <div class="btn-group" id="wBtns">
                <button class="active" onclick="changeRange('w', 7)">7天</button>
                <button onclick="changeRange('w', 30)">1月</button>
                <button onclick="changeRange('w', 90)">3月</button>
                <button onclick="changeRange('w', 180)">半年</button>
                <button onclick="changeRange('w', 365)">1年</button>
            </div>
        </div>
        <div class="chart-container"><canvas id="wChart"></canvas></div>
    </div>

    <div class="card">
        <div class="chart-header">
            <b>血压 & 心率</b>
            <div class="btn-group" id="bpBtns">
                <button class="active" onclick="changeRange('bp', 7)">7天</button>
                <button onclick="changeRange('bp', 30)">1月</button>
                <button onclick="changeRange('bp', 90)">3月</button>
                <button onclick="changeRange('bp', 180)">半年</button>
                <button onclick="changeRange('bp', 365)">1年</button>
            </div>
        </div>
        <div class="chart-container"><canvas id="bpChart"></canvas></div>
    </div>

    <div class="card">
        <h2>历史记录</h2>
        <div id="historyList"></div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('myHealthData') || '{"weight":[], "bp":[], "target":65}');
    let wChart, bpChart;
    let currentWRange = 7, currentBPRange = 7;

    // 初始化日期
    document.getElementById('recDate').value = new Date().toISOString().split('T')[0];

    function saveData() {
        const date = document.getElementById('recDate').value;
        const slot = document.getElementById('recSlot').value;
        const weight = parseFloat(document.getElementById('recWeight').value);
        const high = parseInt(document.getElementById('recHigh').value);
        const low = parseInt(document.getElementById('recLow').value);
        const hr = parseInt(document.getElementById('recHR').value);
        const ts = new Date(date).getTime();

        if (weight) db.weight.push({ date, slot, val: weight, ts });
        if (high && low) db.bp.push({ date, slot, high, low, hr: hr || 0, ts });

        localStorage.setItem('myHealthData', JSON.stringify(db));
        renderAll();
        // 清空输入
        document.getElementById('recWeight').value = '';
        document.getElementById('recHigh').value = '';
        document.getElementById('recLow').value = '';
        document.getElementById('recHR').value = '';
    }

    function deleteItem(type, index) {
        db[type].splice(index, 1);
        localStorage.setItem('myHealthData', JSON.stringify(db));
        renderAll();
    }

    function changeRange(type, day) {
        if(type === 'w') {
            currentWRange = day;
            updateBtnStyle('wBtns', day);
        } else {
            currentBPRange = day;
            updateBtnStyle('bpBtns', day);
        }
        renderAll();
    }

    function updateBtnStyle(groupId, day) {
        const btns = document.getElementById(groupId).getElementsByTagName('button');
        const days = [7, 30, 90, 180, 365];
        for(let i=0; i<btns.length; i++) {
            btns[i].className = (days[i] === day) ? 'active' : '';
        }
    }

    function renderAll() {
        // 更新体重数值
        if(db.weight.length > 0) {
            document.getElementById('curW').innerText = db.weight[db.weight.length-1].val;
        }

        // 1. 体重图表
        const wData = filterAndSort(db.weight, currentWRange);
        if(wChart) wChart.destroy();
        wChart = new Chart(document.getElementById('wChart'), {
            type: 'line',
            data: {
                labels: wData.map(d => d.date.slice(5) + d.slot[0]),
                datasets: [{ label: '体重', data: wData.map(d => d.val), borderColor: '#07c160', tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. 血压心率图表
        const bpData = filterAndSort(db.bp, currentBPRange);
        if(bpChart) bpChart.destroy();
        bpChart = new Chart(document.getElementById('bpChart'), {
            type: 'line',
            data: {
                labels: bpData.map(d => d.date.slice(5) + d.slot[0]),
                datasets: [
                    { label: '高压', data: bpData.map(d => d.high), borderColor: '#ff4d4f' },
                    { label: '低压', data: bpData.map(d => d.low), borderColor: '#1890ff' },
                    { label: '心率', data: bpData.map(d => d.hr), borderColor: '#eb2f96', borderDash: [5,5] }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 3. 列表
        const listDiv = document.getElementById('historyList');
        listDiv.innerHTML = '';
        [...db.weight, ...db.bp].sort((a,b) => b.ts - a.ts).slice(0, 10).forEach((item, idx) => {
            const isW = item.val !== undefined;
            listDiv.innerHTML += `
                <div class="list-item">
                    <div>
                        <div class="item-info">
                            ${isW ? `体重: <b>${item.val} kg</b>` : `血压: <b>${item.high}/${item.low}</b> | 心率: <b>${item.hr}</b>`}
                        </div>
                        <div class="item-date">${item.date} (${item.slot})</div>
                    </div>
                    <span class="del-btn" onclick="alert('请点击记录重新保存或清除缓存重置')">记录中</span>
                </div>`;
        });
    }

    function filterAndSort(arr, days) {
        const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
        return arr.filter(i => i.ts >= cutoff).sort((a,b) => a.ts - b.ts);
    }

    window.onload = renderAll;
</script>
</body>
</html>
