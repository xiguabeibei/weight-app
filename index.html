<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çŒ«çŒ«å¥åº·">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3567/3567440.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3567/3567440.png">

    <title>ä¸ƒå½©æ¢¦å¹»çŒ«çŒ«æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+SC:wght@400;900&display=swap');
        body { background: linear-gradient(-45deg, #fff0f3, #e7f5ff, #f3f0ff, #fff9db); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #444; font-family: 'Noto Sans SC', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
        .cat-bg { position: fixed; top: -10%; z-index: -1; pointer-events: none; animation: catFall linear infinite; font-size: 24px; }
        @keyframes catFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        .floating-card { background: rgba(255, 255, 255, 0.85); border: 4px solid white; backdrop-filter: blur(15px); border-radius: 2.5rem; box-shadow: 0 15px 35px rgba(0,0,0,0.05); animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .card-blue { border-color: #bae1ff; } .card-green { border-color: #baffc9; } .card-purple { border-color: #decaff; } .card-yellow { border-color: #ffffba; } .card-orange { border-color: #ffdfba; } .card-red { border-color: #ffc9c9; }
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-x; border-radius: 1.5rem; margin-bottom: 1rem; background: #ff6b6b !important; }
        .swipe-content { position: relative; z-index: 20; transition: transform 0.4s; background: white !important; width: 100%; }
        .delete-action { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; color: white; display: flex; align-items: center; justify-content: center; z-index: 10; font-weight: 900; }
        .sidebar-active { background: #444 !important; color: white !important; transform: translateX(10px); }
        .text-pop { font-family: 'ZCOOL KuaiLe', cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen p-4 gap-6">
    <div id="cat-container"></div>
    <aside class="w-72 flex flex-col p-6 floating-card">
        <div class="flex flex-col items-center gap-2 mb-10">
            <div class="w-16 h-16 rounded-3xl bg-gradient-to-br from-yellow-300 to-orange-400 flex items-center justify-center shadow-2xl rotate-12 text-white"><i data-lucide="cat"></i></div>
            <h1 class="text-pop text-2xl mt-2 tracking-widest text-orange-500">çŒ«çŒ«å¥åº·</h1>
        </div>
        <nav id="user-nav" class="flex-1 space-y-3 overflow-y-auto no-scrollbar px-2"></nav>
        <button onclick="addUser()" class="w-full p-4 rounded-2xl bg-green-400 text-white flex items-center justify-center gap-3 font-black shadow-lg">æ–°æˆå‘˜</button>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar space-y-8 pb-10">
        <section class="floating-card card-blue p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-pop text-lg text-blue-500">ğŸ¾ ç˜¦èº«çŒ«æ­¥è¿›åº¦</h3>
                <div id="progress-percent" class="bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-xs font-black">0%</div>
            </div>
            <div class="relative w-full h-8 bg-blue-50 rounded-full p-1.5 overflow-hidden border border-blue-100">
                <div id="progress-bar" class="bg-blue-400 h-full rounded-full w-0 transition-all duration-1000"></div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="floating-card card-yellow p-8">
                <h3 class="text-pop text-xl text-yellow-600 mb-6"><i data-lucide="line-chart"></i> ä½“é‡æ›²çº¿</h3>
                <div class="h-60"><canvas id="weightChart"></canvas></div>
            </section>
            <section class="floating-card card-red p-8">
                <h3 class="text-pop text-xl text-red-500 mb-6"><i data-lucide="heart-pulse"></i> è¡€å‹è¶‹åŠ¿ (é«˜/ä½)</h3>
                <div class="h-60"><canvas id="bpChart"></canvas></div>
            </section>
        </div>

        <section class="floating-card card-orange p-8">
            <div class="flex flex-wrap items-center justify-between gap-6 mb-8">
                <input type="date" id="global-date" onchange="render()" class="font-black text-xl text-orange-600 bg-orange-50 p-3 rounded-2xl border-none shadow-inner">
                <div class="flex gap-2 p-2 bg-orange-100 rounded-3xl">
                    <button onclick="setLogType('weight')" id="tab-weight" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">ä½“é‡</button>
                    <button onclick="setLogType('bp')" id="tab-bp" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">è¡€å‹</button>
                    <button onclick="setLogType('food')" id="tab-food" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">é›¶é£Ÿ</button>
                    <button onclick="setLogType('sport')" id="tab-sport" class="px-6 py-2 rounded-2xl font-black text-xs transition-all">è¿åŠ¨</button>
                </div>
            </div>
            <div id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 pb-20">
            <div id="list-food"></div>
            <div id="list-sport"></div>
        </div>
    </main>

    <script>
        let users = JSON.parse(localStorage.getItem('sf_colorful_v2') || '[]');
        let curUid = localStorage.getItem('sf_colorful_uid') || (users[0]?.id || null);
        let entryType = 'weight', charts = {};

        function createCat() {
            const container = document.getElementById('cat-container');
            const cat = document.createElement('div');
            cat.className = 'cat-bg';
            cat.style.left = Math.random() * 100 + 'vw';
            cat.innerText = ['ğŸ±', 'ğŸˆ', 'ğŸ¾', 'ğŸ˜¸'][Math.floor(Math.random()*4)];
            cat.style.animationDuration = Math.random() * 5 + 8 + 's';
            container.appendChild(cat);
            setTimeout(() => cat.remove(), 12000);
        }
        setInterval(createCat, 1000);

        function sync() {
            localStorage.setItem('sf_colorful_v2', JSON.stringify(users));
            if(curUid) localStorage.setItem('sf_colorful_uid', curUid);
            render();
        }

        function addUser() {
            const name = prompt("æˆå‘˜åç§°:"); if(!name) return;
            const u = { id: Date.now(), name, target: 50, weights: [], bps: [], logs: [] };
            users.push(u); curUid = u.id; sync();
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const date = document.getElementById('global-date').value;
            const slot = document.getElementById('e-slot').value;

            if (entryType === 'weight') {
                const val = parseFloat(document.getElementById('e-val').value);
                if (val) u.weights.push({ id: Date.now(), val, slot, date, ts: new Date(date).getTime() });
            } else if (entryType === 'bp') {
                const high = parseInt(document.getElementById('e-high').value);
                const low = parseInt(document.getElementById('e-low').value);
                if (high && low) u.bps.push({ id: Date.now(), high, low, slot, date, ts: new Date(date).getTime() });
            } else {
                const name = document.getElementById('e-name').value, cal = parseInt(document.getElementById('e-cal').value);
                if (name && cal) u.logs.unshift({ id: Date.now(), type: entryType, name, cal, slot, date });
            }
            sync();
        }

        function setLogType(t) { entryType = t; renderEntryForm(); }

        function renderEntryForm() {
            const container = document.getElementById('entry-form');
            ['weight', 'bp', 'food', 'sport'].forEach(t => {
                document.getElementById('tab-'+t).className = entryType === t ? 'px-6 py-2 rounded-2xl font-black text-xs bg-orange-500 text-white shadow-lg' : 'px-6 py-2 rounded-2xl font-black text-xs text-orange-300';
            });

            if(entryType === 'weight') {
                container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl border-none shadow-inner"><option value="æ™¨é—´">æ—©æ™¨</option><option value="æ™šé—´">ç¡å‰</option></select><input type="number" id="e-val" placeholder="ä½“é‡(KG)" class="p-4 rounded-2xl border-none shadow-inner md:col-span-2"><button onclick="submitEntry()" class="bg-orange-500 text-white rounded-2xl font-bold">è®°å½•</button>`;
            } else if(entryType === 'bp') {
                container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl border-none shadow-inner"><option value="æ™¨é—´">æ—©æ™¨</option><option value="æ™šé—´">ç¡å‰</option></select><input type="number" id="e-high" placeholder="é«˜å‹(æ”¶ç¼©)" class="p-4 rounded-2xl border-none shadow-inner"><input type="number" id="e-low" placeholder="ä½å‹(èˆ’å¼ )" class="p-4 rounded-2xl border-none shadow-inner"><button onclick="submitEntry()" class="bg-red-400 text-white rounded-2xl font-bold">è®°å½•</button>`;
            } else {
                container.innerHTML = `<select id="e-slot" class="p-4 rounded-2xl border-none shadow-inner"><option value="é¤å">é¤å</option><option value="è¿åŠ¨å">è¿åŠ¨å</option></select><input type="text" id="e-name" placeholder="åç§°" class="p-4 rounded-2xl border-none shadow-inner"><input type="number" id="e-cal" placeholder="å¡è·¯é‡Œ" class="p-4 rounded-2xl border-none shadow-inner"><button onclick="submitEntry()" class="bg-blue-400 text-white rounded-2xl font-bold">è®°å½•</button>`;
            }
        }

        function renderChart(id, label, data1, data2 = null, color1 = '#fcc419', color2 = '#ff6b6b') {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            
            const datasets = [{
                label: label + (data2 ? ' (é«˜)' : ''),
                data: data1, borderColor: color1, borderWidth: 4, tension: 0.4, fill: false, pointRadius: 4
            }];
            if(data2) datasets.push({
                label: ' (ä½)', data: data2, borderColor: color2, borderWidth: 4, tension: 0.4, fill: false, pointRadius: 4
            });

            charts[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: data1.map((_, i) => i + 1), datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !!data2 } } }
            });
        }

        function render() {
            document.getElementById('user-nav').innerHTML = users.map(u => `<div onclick="curUid=${u.id};sync()" class="p-4 cursor-pointer rounded-2xl font-bold ${curUid == u.id ? 'sidebar-active' : 'text-gray-400'}">${u.name}</div>`).join('');
            const u = users.find(x => x.id == curUid); if(!u) return;

            // ä½“é‡è¿›åº¦
            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            if(sortedW.length) {
                const progress = Math.min(100, Math.max(0, (sortedW[0].val - sortedW[sortedW.length-1].val) / (sortedW[0].val - u.target) * 100));
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-percent').innerText = Math.round(progress) + '%';
            }

            // ç»˜å›¾
            renderChart('weightChart', 'ä½“é‡', sortedW.map(w => w.val));
            const sortedBP = [...u.bps].sort((a,b)=>a.ts-b.ts);
            renderChart('bpChart', 'è¡€å‹', sortedBP.map(b => b.high), sortedBP.map(b => b.low), '#ff6b6b', '#4dabf7');

            renderEntryForm(); lucide.createIcons();
        }

        window.onload = () => {
            document.getElementById('global-date').value = new Date().toISOString().split('T')[0];
            sync();
        };
    </script>
</body>
</html>
