<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FamilyFit Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .ios-bg { background-color: #f2f2f7; }
        .ios-card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-active { color: #007aff; border-bottom: 2px solid #007aff; }
        input[type="date"], input[type="number"] { -webkit-appearance: none; border: none; background: #f2f2f7; padding: 10px; border-radius: 8px; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="ios-bg min-h-screen pb-10">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        
        <div class="flex items-center gap-4 mb-6 overflow-x-auto py-2">
            <div id="user-list" class="flex gap-3"></div>
            <button onclick="showAddUserModal()" class="bg-gray-200 p-3 rounded-full shrink-0"><i data-lucide="plus" class="w-5 h-5"></i></button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="ios-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="display-name" class="text-2xl font-bold text-gray-800">åŠ è½½ä¸­...</h2>
                        <p class="text-sm text-gray-400 mt-1">ç›®æ ‡: <span id="target-val">--</span> kg</p>
                    </div>
                    <div id="distance-tag" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-sm font-bold">è¿˜å·® -- kg</div>
                </div>
                <div class="mt-6">
                    <span class="text-5xl font-black text-slate-800 tabular-nums" id="latest-weight">0.0</span>
                    <span class="text-gray-400 ml-2 text-lg font-medium">kg</span>
                </div>
            </div>

            <div class="ios-card p-6 flex flex-col justify-between">
                <h3 class="text-sm font-bold text-gray-400 mb-4">å¿«é€Ÿè®°å½•ä½“é‡</h3>
                <div class="space-y-3">
                    <div class="flex gap-2 text-sm mb-2">
                        <input type="date" id="input-date" class="flex-1">
                        <select id="input-time" class="bg-gray-100 p-2 rounded-lg outline-none">
                            <option value="morning">æ™¨é—´ (AM)</option>
                            <option value="evening">æ™šé—´ (PM)</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="input-val" step="0.1" placeholder="ä½“é‡" class="flex-1 text-lg font-bold">
                        <button onclick="addWeightRecord()" class="bg-blue-600 text-white px-6 rounded-xl font-bold active:scale-95 transition-all">è®°å½•</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="showLogModal('food')" class="ios-card p-4 flex items-center justify-center gap-3 font-bold text-orange-600 border border-orange-100 hover:bg-orange-50 transition-colors">
                <i data-lucide="utensils"></i> è®°é¥®é£Ÿ
            </button>
            <button onclick="showLogModal('sport')" class="ios-card p-4 flex items-center justify-center gap-3 font-bold text-green-600 border border-green-100 hover:bg-green-50 transition-colors">
                <i data-lucide="dumbbell"></i> è®°è¿åŠ¨
            </button>
        </div>

        <div class="ios-card p-6 mb-6">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-2">
                <h3 class="font-bold flex items-center gap-2 text-gray-700"><i data-lucide="line-chart" class="w-5 h-5"></i> è¶‹åŠ¿åˆ†æ</h3>
                <div class="flex bg-gray-100 p-1 rounded-lg text-xs font-bold text-gray-500">
                    <button onclick="setChartRange(7)" class="range-btn px-3 py-1 rounded-md" id="r-7">ä¸€å‘¨</button>
                    <button onclick="setChartRange(30)" class="range-btn px-3 py-1 rounded-md" id="r-30">ä¸€æœˆ</button>
                    <button onclick="setChartRange(90)" class="range-btn px-3 py-1 rounded-md" id="r-90">ä¸‰æœˆ</button>
                    <button onclick="setChartRange(180)" class="range-btn px-3 py-1 rounded-md" id="r-180">åŠå¹´</button>
                </div>
            </div>
            <div class="h-64">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
    </div>

    <div id="user-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-center">æ·»åŠ æ–°æˆå‘˜</h3>
            <div class="space-y-4">
                <input type="text" id="new-name" placeholder="æˆå‘˜æ˜µç§° (ä¾‹: ä¸ˆå¤«)" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100">
                <input type="number" id="new-target" placeholder="ç›®æ ‡ä½“é‡ (kg)" class="w-full bg-gray-50 p-4 rounded-xl outline-none border border-gray-100">
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal('user-modal')" class="flex-1 py-4 font-bold text-gray-400">å–æ¶ˆ</button>
                    <button onclick="addUser()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200">åˆ›å»ºå¹¶ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <div id="log-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <h3 id="log-modal-title" class="text-xl font-bold mb-6">æ·»åŠ è®°å½•</h3>
            <input type="text" id="log-name" placeholder="é¡¹ç›® (å¦‚: è·‘æ­¥/ç±³é¥­)" class="w-full bg-gray-50 p-4 rounded-xl mb-4 border border-gray-100 outline-none">
            <input type="number" id="log-cal" placeholder="çƒ­é‡ (kcal)" class="w-full bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100 outline-none">
            <div class="flex gap-4">
                <button onclick="closeModal('log-modal')" class="flex-1 py-4 font-bold text-gray-400">å–æ¶ˆ</button>
                <button onclick="saveLog()" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        let users = JSON.parse(localStorage.getItem('ff_users') || '[]');
        let currentUserId = localStorage.getItem('ff_current_uid') || null;
        let chart = null;
        let chartRange = 30;
        let currentLogType = 'food';

        // åˆå§‹åŒ–æ—¥æœŸ
        document.getElementById('input-date').valueAsDate = new Date();

        function sync() {
            localStorage.setItem('ff_users', JSON.stringify(users));
            if(currentUserId) localStorage.setItem('ff_current_uid', currentUserId);
            renderAll();
        }

        // --- ç”¨æˆ·æ“ä½œ ---
        function addUser() {
            const name = document.getElementById('new-name').value;
            const target = parseFloat(document.getElementById('new-target').value);
            if(!name || !target) return alert('è¯·å®Œæ•´å¡«å†™');
            
            const newUser = { id: Date.now(), name, target, weights: [], logs: [] };
            users.push(newUser);
            currentUserId = newUser.id;
            closeModal('user-modal');
            document.getElementById('new-name').value = '';
            document.getElementById('new-target').value = '';
            sync();
        }

        function switchUser(id) {
            currentUserId = id;
            sync();
        }

        function showAddUserModal() { document.getElementById('user-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- ä½“é‡è®°å½• ---
        function addWeightRecord() {
            const val = parseFloat(document.getElementById('input-val').value);
            const date = document.getElementById('input-date').value;
            const timeSlot = document.getElementById('input-time').value;
            if(!val || !currentUserId) return alert('è¯·è¾“å…¥ä½“é‡ä¸”ç¡®ä¿ç”¨æˆ·å·²ç™»å½•');

            const user = users.find(u => u.id == currentUserId);
            // æŸ¥æ‰¾æ˜¯å¦åŒä¸€å¤©åŒä¸€æ—¶é—´ç‚¹å·²æœ‰è®°å½•ï¼Œæœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ–°å¢
            const existing = user.weights.find(w => w.date === date && w.slot === timeSlot);
            if(existing) {
                existing.val = val;
            } else {
                user.weights.push({ val, date, slot: timeSlot, ts: Date.now() });
            }
            
            // æ’åº
            user.weights.sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('input-val').value = '';
            sync();
        }

        // --- é¥®é£Ÿè¿åŠ¨ ---
        function showLogModal(type) {
            currentLogType = type;
            document.getElementById('log-modal-title').innerText = type === 'food' ? 'ğŸ¥— è®°å½•é¥®é£Ÿ' : 'ğŸƒ è®°å½•è¿åŠ¨';
            document.getElementById('log-modal').classList.remove('hidden');
        }

        function saveLog() {
            const name = document.getElementById('log-name').value;
            const cal = parseInt(document.getElementById('log-cal').value);
            if(!name || !cal || !currentUserId) return;

            const user = users.find(u => u.id == currentUserId);
            user.logs.unshift({ type: currentLogType, name, cal, date: new Date().toLocaleDateString(), ts: Date.now() });
            
            closeModal('log-modal');
            document.getElementById('log-name').value = '';
            document.getElementById('log-cal').value = '';
            sync();
        }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function setChartRange(days) {
            chartRange = days;
            renderAll();
        }

        function renderAll() {
            // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
            const listEl = document.getElementById('user-list');
            listEl.innerHTML = users.map(u => `
                <button onclick="switchUser(${u.id})" class="shrink-0 px-6 py-3 rounded-2xl font-bold transition-all ${currentUserId == u.id ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-gray-500'}">
                    ${u.name}
                </button>
            `).join('');

            const user = users.find(u => u.id == currentUserId);
            if(!user) {
                if(users.length > 0) switchUser(users[0].id);
                else document.getElementById('display-name').innerText = "è¯·å…ˆæ·»åŠ æˆå‘˜";
                return;
            }

            // æ›´æ–°é¢æ¿
            document.getElementById('display-name').innerText = user.name;
            document.getElementById('target-val').innerText = user.target;
            const latest = user.weights[0]?.val || 0;
            document.getElementById('latest-weight').innerText = latest.toFixed(1);
            const dist = latest - user.target;
            document.getElementById('distance-tag').innerText = dist > 0 ? `è¿˜å·® ${dist.toFixed(1)} kg` : `å·²è¾¾æˆç›®æ ‡ï¼`;
            document.getElementById('distance-tag').className = dist <= 0 ? "bg-green-50 text-green-600 px-3 py-1 rounded-full text-sm font-bold" : "bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-sm font-bold";

            // èŒƒå›´é€‰æ‹©é«˜äº®
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('tab-active', 'bg-white', 'shadow-sm'));
            const activeRange = document.getElementById(`r-${chartRange}`);
            if(activeRange) activeRange.classList.add('bg-white', 'shadow-sm', 'text-blue-600');

            renderChart(user.weights);
            lucide.createIcons();
        }

        function renderChart(weights) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - chartRange);

            // è¿‡æ»¤å¹¶æŒ‰æ—¥æœŸæ’åº
            const filtered = weights
                .filter(w => new Date(w.date) >= cutoff)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            // å¤„ç†æ•°æ®ç‚¹ï¼šå¦‚æœæœ‰æ—©æ™šä¸¤ä¸ªç‚¹ï¼Œåœ¨å›¾è¡¨ä¸Šéƒ½ä¼šæ˜¾ç¤º
            const labels = filtered.map(w => {
                const d = w.date.substring(5);
                return w.slot === 'morning' ? d + ' AM' : d + ' PM';
            });
            const values = filtered.map(w => w.val);

            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: '#007aff',
                        backgroundColor: 'rgba(0, 122, 255, 0.05)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: '#f2f2f7' }, ticks: { font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.onload = renderAll;
    </script>
</body>
</html>
