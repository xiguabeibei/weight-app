<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>å®¶åº­å¥åº·è®°å½•</title>

<style>
:root{
 --bg:#f6f7fb;
 --card:#ffffff;
 --text:#222;
 --primary:#ff8fb1;
 --accent:#a78bfa;
}
body.dark{
 --bg:#1e1e2f;
 --card:#2b2b3c;
 --text:#f4f4f5;
}
body{
 margin:0;
 font-family:-apple-system,BlinkMacSystemFont,"PingFang SC";
 background:var(--bg);
 color:var(--text);
 display:flex;
 height:100vh;
}
aside{
 width:260px;
 background:var(--card);
 box-shadow:4px 0 20px rgba(0,0,0,.08);
 padding:16px;
 overflow:auto;
}
aside h3{margin-top:0;}
aside button, aside select{
 width:100%;
 margin-bottom:8px;
 padding:10px;
 border:none;
 border-radius:12px;
}
.member div{
 padding:6px 10px;
 border-radius:10px;
 cursor:pointer;
}
.member div:hover{background:#ddd}
main{
 flex:1;
 padding:20px;
 overflow:auto;
}
.card{
 background:var(--card);
 border-radius:20px;
 padding:16px;
 margin-bottom:16px;
 box-shadow:0 10px 30px rgba(0,0,0,.1);
}
input{
 width:100%;
 padding:12px;
 border-radius:12px;
 border:1px solid #ccc;
 margin-bottom:10px;
}
.primary{
 background:linear-gradient(135deg,var(--primary),var(--accent));
 color:#fff;
 border:none;
 padding:12px;
 border-radius:999px;
 width:100%;
}
canvas{width:100%;height:220px}
.progress{
 height:14px;
 background:#ddd;
 border-radius:999px;
 overflow:hidden;
}
.progress div{
 height:100%;
 background:linear-gradient(135deg,#67e8f9,#a78bfa);
}
.tip{margin-top:10px;color:var(--primary);}
</style>
</head>

<body>

<aside>
<h3>è®¾ç½®</h3>
<button onclick="openSettings()">æ·»åŠ æˆå‘˜</button>
<select onchange="setTheme(this.value)">
 <option value="system">è·Ÿéšç³»ç»Ÿ</option>
 <option value="light">æ—¥é—´æ¨¡å¼</option>
 <option value="dark">å¤œé—´æ¨¡å¼</option>
</select>

<h3>æˆå‘˜ä¿¡æ¯</h3>
<div id="members"></div>
</aside>

<main>
<div id="content"></div>
</main>

<script>
let store=JSON.parse(localStorage.getItem("healthFinal")||"{}");
let currentUser=null;
let page="weight";
let timeType="pm";
let range=7;

function save(){localStorage.setItem("healthFinal",JSON.stringify(store));}

/* ---------- ä¸»é¢˜ ---------- */
function setTheme(t){
 localStorage.setItem("theme",t);
 applyTheme();
}
function applyTheme(){
 const t=localStorage.getItem("theme")||"system";
 if(t==="dark")document.body.classList.add("dark");
 else if(t==="light")document.body.classList.remove("dark");
 else{
  document.body.classList.toggle("dark",
   window.matchMedia("(prefers-color-scheme: dark)").matches);
 }
}
applyTheme();

/* ---------- æˆå‘˜ ---------- */
function renderMembers(){
 members.innerHTML="";
 Object.keys(store).forEach(n=>{
  const d=document.createElement("div");
  d.className="member";
  d.innerHTML=`
   <strong>${n}</strong>
   <div onclick="open('${n}','weight')">ä½“é‡è®°å½•</div>
   <div onclick="open('${n}','food')">é¥®é£Ÿæ‘„å…¥</div>
   <div onclick="open('${n}','sport')">è¿åŠ¨å‡è„‚</div>
  `;
  members.appendChild(d);
 });
}
renderMembers();

function open(name,p){
 currentUser=name;
 page=p;
 render();
}

function openSettings(){
 page="settings";
 render();
}

/* ---------- æ¸²æŸ“æ ¸å¿ƒï¼ˆå·²ä¿®å¤ï¼‰ ---------- */
function render(){
 // âœ… è®¾ç½®é¡µä¼˜å…ˆ
 if(page==="settings"){
  content.innerHTML=`
   <div class="card">
    <h2>æ·»åŠ æˆå‘˜</h2>
    <input id="name" placeholder="æˆå‘˜å">
    <input id="start" placeholder="åˆå§‹ä½“é‡">
    <input id="target" placeholder="ç›®æ ‡ä½“é‡">
    <button class="primary" onclick="addMember()">ä¿å­˜æˆå‘˜</button>
   </div>`;
  return;
 }

 // å…¶ä»–é¡µé¢æ‰è¦æ±‚å·²æœ‰æˆå‘˜
 if(!currentUser){
  content.innerHTML="<div class='card'>è¯·å…ˆæ·»åŠ æˆå‘˜</div>";
  return;
 }

 const today=new Date().toISOString().slice(0,10);
 const profile=store[currentUser].profile;
 content.innerHTML=`
 <div class="card">
  <h2>${currentUser}</h2>
  <div>åˆå§‹ ${profile.start}kg â†’ ç›®æ ‡ ${profile.target}kg</div>
  <div class="progress"><div style="width:${progress()}%"></div></div>
  <div class="tip">${tip()}</div>
 </div>
 ${page==="weight"?weightUI(today):""}
 ${page==="food"?foodUI(today):""}
 ${page==="sport"?sportUI(today):""}
 `;
 if(page==="weight")drawWeight();
}

/* ---------- æ•°æ® ---------- */
function ensure(date){
 store[currentUser].records=store[currentUser].records||{};
 store[currentUser].records[date]=store[currentUser].records[date]||{
  am:{},pm:{},foods:[],foodTotal:0,sport:[],sportTotal:0
 };
}

function addMember(){
 const n=name.value;
 if(!n)return;
 store[n]={profile:{
  start:Number(start.value),
  target:Number(target.value)
 },records:{}};
 save();
 renderMembers();
 open(n,"weight");
}

/* ---------- ä½“é‡ ---------- */
function weightUI(date){
 return `
 <div class="card">
  <input type="date" id="date" value="${date}">
  <button onclick="timeType='am'">æ—©</button>
  <button onclick="timeType='pm'">æ™š</button>
  <input id="w" placeholder="ä½“é‡ kg">
  <button class="primary" onclick="saveWeight()">ä¿å­˜</button>
  <select onchange="range=this.value;drawWeight()">
   <option value="7">7å¤©</option><option value="30">1æœˆ</option>
   <option value="90">3æœˆ</option><option value="180">åŠå¹´</option>
   <option value="365">1å¹´</option>
  </select>
  <canvas id="wc"></canvas>
 </div>`;
}

function saveWeight(){
 const d=document.getElementById("date").value;
 ensure(d);
 store[currentUser].records[d][timeType].weight=Number(w.value);
 save();drawWeight();render();
}

function drawWeight(){
 const c=wc.getContext("2d");
 c.clearRect(0,0,300,300);
 const rec=Object.entries(store[currentUser].records)
  .slice(-range)
  .map(r=>r[1].pm.weight).filter(Boolean);
 if(!rec.length)return;
 c.beginPath();
 rec.forEach((v,i)=>{
  const x=i*(300/rec.length);
  const y=220-(v/Math.max(...rec))*180;
  i?c.lineTo(x,y):c.moveTo(x,y);
 });
 c.strokeStyle="#ff8fb1";
 c.lineWidth=3;
 c.stroke();
}

/* ---------- æ¿€åŠ± ---------- */
function progress(){
 const p=store[currentUser].profile;
 const last=Object.values(store[currentUser].records).at(-1)?.pm?.weight;
 if(!last)return 0;
 return Math.min(100,(p.start-last)/(p.start-p.target)*100);
}
function tip(){
 const p=store[currentUser].profile;
 const last=Object.values(store[currentUser].records).at(-1)?.pm?.weight;
 if(!last)return "ä»ä»Šå¤©å¼€å§‹è®°å½•å§ ğŸŒ±";
 const diff=(last-p.target).toFixed(1);
 return diff>0?`è·ç¦»ç›®æ ‡è¿˜å·® ${diff}kgï¼ŒåŠ æ²¹ ğŸ’ª`:"å·²è¾¾æˆç›®æ ‡ï¼Œå¤ªæ£’äº† ğŸ‰";
}
</script>

</body>
</html>
