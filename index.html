<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>健康管理Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f2f2f7; color: #1c1c1e; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; }
        .wechat-card { background: white; border-radius: 16px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .wechat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
        
        /* 侧边栏动画 */
        #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-hidden { transform: translateX(-100%); width: 0 !important; opacity: 0; margin: 0 !important; }

        /* 滑动删除 */
        .swipe-container { position: relative; overflow: hidden; touch-action: pan-x; border-radius: 12px; margin-bottom: 8px; background: #ff3b30; }
        .swipe-content { position: relative; z-index: 10; transition: transform 0.3s ease; background: white; width: 100%; border-bottom: 1px solid #f2f2f7; cursor: pointer; }
        .delete-btn { position: absolute; right: 0; top: 0; bottom: 0; width: 80px; color: white; display: flex; align-items: center; justify-content: center; z-index: 5; font-size: 16px; font-weight: 600; }

        /* 字体与组件 */
        .text-xl-plus { font-size: 1.25rem; }
        .tab-active { color: #34c759; border-bottom: 3px solid #34c759; }
        .range-btn { font-size: 13px; padding: 4px 12px; border-radius: 20px; color: #8e8e93; background: #e5e5ea; transition: all 0.2s; }
        .range-btn.active { background: #34c759; color: white; box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3); }
        
        input, select { outline: none; border: 1px solid #e5e5ea; border-radius: 10px; padding: 12px; font-size: 16px; background: #f9f9f9; width: 100%; }
        input:focus { border-color: #34c759; background: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen">

    <aside id="sidebar" class="w-72 bg-[#f2f2f7] flex flex-col p-5 shrink-0 border-r border-gray-200">
        <div class="flex items-center justify-between mb-8">
            <span class="text-xl font-bold">档案中心</span>
            <button onclick="toggleSidebar()"><i data-lucide="chevron-left" class="text-gray-400"></i></button>
        </div>
        <div id="user-nav" class="flex-1 space-y-2 overflow-y-auto no-scrollbar"></div>
        <button onclick="addUser()" class="mt-4 w-full py-4 bg-white text-[#34c759] text-lg font-bold rounded-2xl shadow-sm border border-gray-100">+ 添加新成员</button>
    </aside>

    <main class="flex-1 flex flex-col overflow-y-auto no-scrollbar">
        <header class="bg-white/80 backdrop-blur-md px-6 py-5 flex items-center justify-between sticky top-0 z-30 border-b border-gray-100">
            <div class="flex items-center gap-4">
                <button id="sidebar-open" onclick="toggleSidebar()" class="hidden p-2 bg-gray-100 rounded-lg"><i data-lucide="menu"></i></button>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">当前查看</span>
                    <input type="date" id="view-date" onchange="render()" class="border-none p-0 font-bold text-xl bg-transparent focus:ring-0 w-auto">
                </div>
            </div>
            <button onclick="openManageModal()" class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 hover:bg-gray-100 transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <div class="p-5 space-y-6">
            <section class="wechat-card p-6 border border-white shadow-sm">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h1 id="display-name" class="text-4xl font-black">--</h1>
                            <div id="display-gender"></div>
                        </div>
                        <div class="flex gap-4">
                            <span class="bg-gray-100 px-3 py-1 rounded-full text-sm text-gray-500 font-medium">目标: <b id="display-target" class="text-black">--</b> KG</span>
                            <span onclick="editWish()" class="bg-green-50 px-3 py-1 rounded-full text-sm text-green-600 font-medium cursor-pointer">愿望: <b id="display-wish">点击设置</b></span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="weight-diff" class="text-5xl font-black text-[#34c759]">0.0</div>
                        <p class="text-xs text-gray-400 font-bold mt-1 uppercase">KG Remaining</p>
                    </div>
                </div>
                <div id="display-mood" onclick="editMood()" class="bg-gray-50 p-4 rounded-2xl text-lg text-gray-600 cursor-pointer italic hover:bg-gray-100 transition-colors">
                    “ 记录今日感悟... ”
                </div>
            </section>

            <section class="wechat-card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">个人兴趣</h3>
                    <button onclick="addInterest()" class="text-[#34c759] p-1"><i data-lucide="plus-circle"></i></button>
                </div>
                <div id="interest-list" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="wechat-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-lg font-bold">体重轨迹</span>
                        <div class="flex gap-1 overflow-x-auto no-scrollbar py-1" id="w-range-btns">
                            <button onclick="updateRange('weight', 7)" class="range-btn">7天</button>
                            <button onclick="updateRange('weight', 30)" class="range-btn">1月</button>
                            <button onclick="updateRange('weight', 90)" class="range-btn">3月</button>
                            <button onclick="updateRange('weight', 180)" class="range-btn">半年</button>
                            <button onclick="updateRange('weight', 365)" class="range-btn">1年</button>
                        </div>
                    </div>
                    <div class="h-64"><canvas id="weightChart"></canvas></div>
                </div>
                <div class="wechat-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-lg font-bold">血压 & 心率</span>
                        <div class="flex gap-1 overflow-x-auto no-scrollbar py-1" id="bp-range-btns">
                            <button onclick="updateRange('bp', 7)" class="range-btn">7天</button>
                            <button onclick="updateRange('bp', 30)" class="range-btn">1月</button>
                            <button onclick="updateRange('bp', 90)" class="range-btn">3月</button>
                            <button onclick="updateRange('bp', 180)" class="range-btn">半年</button>
                            <button onclick="updateRange('bp', 365)" class="range-btn">1年</button>
                        </div>
                    </div>
                    <div class="h-64"><canvas id="bpChart"></canvas></div>
                </div>
            </div>

            <section class="wechat-card p-6 shadow-lg border-2 border-white">
                <div class="flex border-b border-gray-100 mb-6 overflow-x-auto no-scrollbar">
                    <button onclick="setLogType('weight')" id="tab-weight" class="px-6 py-3 text-lg font-bold whitespace-nowrap">测体重</button>
                    <button onclick="setLogType('bp')" id="tab-bp" class="px-6 py-3 text-lg font-bold whitespace-nowrap">量血压</button>
                    <button onclick="setLogType('food')" id="tab-food" class="px-6 py-3 text-lg font-bold whitespace-nowrap">吃补给</button>
                    <button onclick="setLogType('sport')" id="tab-sport" class="px-6 py-3 text-lg font-bold whitespace-nowrap">去消耗</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                    <div class="lg:col-span-1">
                        <label class="text-xs font-bold text-gray-400 mb-1 block">记录日期</label>
                        <input type="date" id="log-date" class="bg-white border-gray-200">
                    </div>
                    <div id="entry-form-fields" class="lg:col-span-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        </div>
                    <button onclick="submitEntry()" class="lg:col-span-1 h-[46px] bg-[#34c759] text-white rounded-xl font-bold text-lg hover:brightness-110 active:scale-95 transition-all">确认</button>
                </div>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-24">
                <div id="list-food"></div>
                <div id="list-sport"></div>
                <div id="list-bp"></div>
            </div>
        </div>
    </main>

    <div id="manage-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl scale-in">
            <h2 class="text-2xl font-black mb-6">修改档案设置</h2>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-400 ml-1">姓名</label><input type="text" id="m-name" class="mt-1"></div>
                <div><label class="text-xs font-bold text-gray-400 ml-1">性别</label><select id="m-gender" class="mt-1"><option value="female">女生</option><option value="male">男生</option></select></div>
                <div><label class="text-xs font-bold text-gray-400 ml-1">目标体重 (KG)</label><input type="number" id="m-target" class="mt-1"></div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeManageModal()" class="flex-1 py-4 text-gray-400 font-bold">取消</button>
                <button onclick="saveUserManage()" class="flex-1 py-4 bg-black text-white rounded-2xl font-bold">保存修改</button>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('health_v3_core') || '[]');
        let curUid = localStorage.getItem('health_uid_v3') || (users[0]?.id || null);
        let entryType = 'weight', charts = {}, ranges = { weight: 7, bp: 7 };

        // 滑动删除逻辑
        let tStart = 0, currentSwipeEl = null;
        document.addEventListener('touchstart', e => {
            const content = e.target.closest('.swipe-content');
            if (content) {
                document.querySelectorAll('.swipe-content').forEach(el => { if(el !== content) el.style.transform = 'translateX(0)'; });
                tStart = e.touches[0].clientX;
                currentSwipeEl = content;
            }
        });
        document.addEventListener('touchmove', e => {
            if (!currentSwipeEl) return;
            let diff = e.touches[0].clientX - tStart;
            if (diff < -10) currentSwipeEl.style.transform = `translateX(${Math.max(diff, -80)}px)`;
            if (diff > 10) currentSwipeEl.style.transform = `translateX(0)`;
        });
        document.addEventListener('touchend', e => {
            if (!currentSwipeEl) return;
            let diff = e.changedTouches[0].clientX - tStart;
            currentSwipeEl.style.transform = diff < -40 ? `translateX(-80px)` : `translateX(0)`;
            currentSwipeEl = null;
        });

        function sync() {
            localStorage.setItem('health_v3_core', JSON.stringify(users));
            if(curUid) localStorage.setItem('health_uid_v3', curUid);
            render();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-hidden');
            document.getElementById('sidebar-open').classList.toggle('hidden');
        }

        function setLogType(t) { entryType = t; renderEntryForm(); }
        function updateRange(type, day) { ranges[type] = day; sync(); }

        function renderEntryForm() {
            const container = document.getElementById('entry-form-fields');
            ['weight', 'bp', 'food', 'sport'].forEach(t => {
                document.getElementById('tab-'+t).className = `px-6 py-3 text-lg font-bold transition-all ${entryType === t ? 'tab-active' : 'text-gray-300'}`;
            });

            if(entryType === 'weight') {
                container.innerHTML = `<div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">时段</label><select id="e-slot"><option>早起</option><option>睡前</option></select></div><div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">体重 (KG)</label><input type="number" id="e-val" placeholder="0.0"></div>`;
            } else if(entryType === 'bp') {
                container.innerHTML = `<div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">时段</label><select id="e-slot"><option>早起</option><option>睡前</option></select></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">收缩/舒张</label><div class="flex items-center gap-1"><input type="number" id="e-high" placeholder="高压"><input type="number" id="e-low" placeholder="低压"></div></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">心率 (BPM)</label><input type="number" id="e-hr" placeholder="心率"></div>`;
            } else if(entryType === 'food') {
                container.innerHTML = `<div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">补给类型</label><select id="e-slot"><option>早餐</option><option>午餐</option><option>晚餐</option><option>甜品</option></select></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">名称</label><input type="text" id="e-name" placeholder="吃了什么?"></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">热量 (Kcal)</label><input type="number" id="e-cal" placeholder="0"></div>`;
            } else {
                container.innerHTML = `<div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">运动模式</label><select id="e-slot"><option>单人运动</option><option>双人运动</option></select></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">项目名称</label><input type="text" id="e-name" placeholder="做了什么?"></div><div><label class="text-[10px] font-bold text-gray-400 mb-1 block uppercase">消耗 (Kcal)</label><input type="number" id="e-cal" placeholder="0"></div>`;
            }
        }

        function submitEntry() {
            const u = users.find(x => x.id == curUid); if(!u) return;
            const logDate = document.getElementById('log-date').value;
            const slot = document.getElementById('e-slot').value;
            const ts = new Date(logDate).getTime();

            if(entryType === 'weight') {
                const val = parseFloat(document.getElementById('e-val').value);
                if(val) u.weights.push({ id: Date.now(), val, date: logDate, slot, ts });
            } else if(entryType === 'bp') {
                const high = parseInt(document.getElementById('e-high').value);
                const low = parseInt(document.getElementById('e-low').value);
                const hr = parseInt(document.getElementById('e-hr').value);
                if(high && low) u.bps.push({ id: Date.now(), high, low, hr, date: logDate, slot, ts });
            } else {
                const name = document.getElementById('e-name').value;
                const cal = parseInt(document.getElementById('e-cal').value);
                if(name) u.logs.unshift({ id: Date.now(), type: entryType, name, cal: cal||0, slot, date: logDate });
            }
            sync();
        }

        function render() {
            const uNav = document.getElementById('user-nav');
            uNav.innerHTML = users.map(u => `
                <div class="swipe-container shadow-sm">
                    <div class="delete-btn" onclick="deleteItem(${u.id}, 'user')">注销</div>
                    <div onclick="curUid=${u.id};sync()" class="swipe-content p-4 rounded-xl text-lg font-bold ${curUid == u.id ? 'text-[#34c759] bg-white shadow-md' : 'text-gray-400'}">
                        ${u.name}
                    </div>
                </div>`).join('');
            
            const u = users.find(x => x.id == curUid); if(!u) return;

            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-target').innerText = u.target || '50.0';
            document.getElementById('display-wish').innerText = u.wish || '设置愿望';
            document.getElementById('display-mood').innerText = u.mood ? `“ ${u.mood} ”` : '“ 记录今日感悟... ”';
            document.getElementById('display-gender').innerHTML = `<i data-lucide="${u.gender==='male'?'mars':'venus'}" class="w-6 h-6 ${u.gender==='male'?'text-blue-500':'text-pink-500'}"></i>`;

            const sortedW = [...u.weights].sort((a,b)=>a.ts-b.ts);
            const curW = sortedW.length ? sortedW[sortedW.length-1].val : (u.target || 0);
            document.getElementById('weight-diff').innerText = (curW - (u.target || 0)).toFixed(1);
            
            // 兴趣
            document.getElementById('interest-list').innerHTML = (u.interests || []).map(i => `
                <div class="swipe-container">
                    <div class="delete-btn" onclick="deleteItem(${i.id}, 'interest')">删除</div>
                    <div class="swipe-content p-4 flex justify-between items-center border border-gray-50 rounded-xl">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleInterest(${i.id})" class="transition-transform active:scale-90 text-${i.paused?'gray-300':'[#34c759]'}">
                                <i data-lucide="${i.paused?'play-circle':'pause-circle'}" class="w-8 h-8"></i>
                            </button>
                            <span class="text-lg font-bold ${i.paused?'text-gray-300 line-through':''}">${i.name}</span>
                        </div>
                        <span class="text-xs font-black text-gray-400 bg-gray-100 px-2 py-1 rounded">坚持 ${Math.floor((Date.now()-i.start)/86400000)+1}天</span>
                    </div>
                </div>`).join('');

            // 列表详情
            const vDate = document.getElementById('view-date').value;
            const logs = u.logs.filter(l => l.date === vDate);
            const listTpl = (l, color) => `
                <div class="swipe-container shadow-sm">
                    <div class="delete-btn" onclick="deleteItem(${l.id}, 'log')">删除</div>
                    <div class="swipe-content p-4 flex justify-between items-center">
                        <div><div class="font-bold text-lg">${l.name}</div><div class="text-xs text-gray-400 font-bold uppercase">${l.slot}</div></div>
                        <div class="text-xl font-black text-${color}-500">${l.cal} <small class="text-[10px]">Kcal</small></div>
                    </div>
                </div>`;
            document.getElementById('list-food').innerHTML = `<p class="text-xs font-black text-gray-400 mb-2 ml-1">补给记录</p>` + logs.filter(l=>l.type==='food').map(l=>listTpl(l, 'orange')).join('');
            document.getElementById('list-sport').innerHTML = `<p class="text-xs font-black text-gray-400 mb-2 ml-1">消耗记录</p>` + logs.filter(l=>l.type==='sport').map(l=>listTpl(l, 'blue')).join('');
            
            const dayBps = u.bps.filter(b => b.date === vDate);
            document.getElementById('list-bp').innerHTML = `<p class="text-xs font-black text-gray-400 mb-2 ml-1">血压/心率记录</p>` + dayBps.map(b => `
                <div class="swipe-container shadow-sm">
                    <div class="delete-btn" onclick="deleteItem(${b.id}, 'bp_record')">删除</div>
                    <div class="swipe-content p-4">
                        <div class="flex justify-between items-end">
                            <div class="font-bold text-[#34c759]">${b.slot}</div>
                            <div class="text-lg font-black">${b.high}/${b.low} <small class="text-[10px] text-gray-400">mmHg</small></div>
                        </div>
                        <div class="text-xs font-bold text-gray-400 mt-1">心率: ${b.hr} BPM</div>
                    </div>
                </div>`).join('');

            updateCharts(u); renderEntryForm(); lucide.createIcons();
        }

        function updateCharts(u) {
            const filterData = (arr, day) => {
                const limit = Date.now() - day * 86400000;
                return arr.filter(i => i.ts >= limit).sort((a,b)=>a.ts-b.ts);
            };

            // 体重图表
            const wd = filterData(u.weights, ranges.weight);
            if(charts.w) charts.w.destroy();
            charts.w = new Chart(document.getElementById('weightChart'), {
                type: 'line', 
                data: { labels: wd.map(d=>d.date.slice(5)), datasets: [{ data: wd.map(d=>d.val), borderColor: '#34c759', borderWidth: 4, pointRadius: 4, tension: 0.3, fill: true, backgroundColor: 'rgba(52,199,89,0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#f2f2f7' }, ticks: { font: { weight: 'bold' } } }, x: { grid: { display: false }, ticks: { font: { weight: 'bold' } } } } }
            });

            // 血压心率图表
            const bd = filterData(u.bps, ranges.bp);
            if(charts.bp) charts.bp.destroy();
            charts.bp = new Chart(document.getElementById('bpChart'), {
                type: 'line', 
                data: {
                    labels: bd.map(d=>d.date.slice(5) + (d.slot.includes('早')?'早':'晚')),
                    datasets: [
                        { label: '收缩压', data: bd.map(d=>d.high), borderColor: '#ff3b30', borderWidth: 3, tension: 0.3 },
                        { label: '舒张压', data: bd.map(d=>d.low), borderColor: '#007aff', borderWidth: 3, tension: 0.3 },
                        { label: '心率', data: bd.map(d=>d.hr), borderColor: '#ff2d55', borderWidth: 2, borderDash: [5,5], tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { weight: 'bold', size: 10 } } } },
                    scales: { 
                        y: { position: 'left', grid: { color: '#f2f2f7' } },
                        y1: { position: 'right', grid: { display: false }, ticks: { color: '#ff2d55' } }
                    }
                }
            });

            // 范围按钮样式
            const btnGrps = { weight: 'w-range-btns', bp: 'bp-range-btns' };
            Object.keys(btnGrps).forEach(type => {
                document.querySelectorAll(`#${btnGrps[type]} .range-btn`).forEach((btn, idx) => {
                    const d = [7, 30, 90, 180, 365][idx];
                    btn.className = `range-btn ${ranges[type] === d ? 'active' : ''}`;
                });
            });
        }

        function editWish() { const u=users.find(x=>x.id==curUid); const w=prompt("新愿望/目标:", u.wish); if(w!==null){u.wish=w; sync();} }
        function editMood() { const u=users.find(x=>x.id==curUid); const m=prompt("今日感悟:", u.mood); if(m!==null){u.mood=m; sync();} }
        function toggleInterest(id) { const u=users.find(x=>x.id==curUid); const i=u.interests.find(it=>it.id===id); i.paused=!i.paused; sync(); }
        function addInterest() { const n=prompt("兴趣名称:"); if(n){ const u=users.find(x=>x.id==curUid); (u.interests=u.interests||[]).push({id:Date.now(), name:n, start:Date.now(), paused:false}); sync(); } }
        function addUser() { const n=prompt("名称:"); if(n){ users.push({id:Date.now(), name:n, target:60, gender:'female', weights:[], bps:[], logs:[], interests:[]}); sync(); } }
        function deleteItem(id, type) {
            if(type==='user') { users=users.filter(u=>u.id!==id); curUid=users[0]?.id || null; }
            else { const u=users.find(x=>x.id==curUid); if(type==='interest') u.interests=u.interests.filter(i=>i.id!==id); else if(type==='bp_record') u.bps=u.bps.filter(b=>b.id!==id); else u.logs=u.logs.filter(l=>l.id!==id); }
            sync();
        }
        function openManageModal() { const u=users.find(x=>x.id==curUid); document.getElementById('m-name').value=u.name; document.getElementById('m-target').value=u.target; document.getElementById('manage-modal').classList.remove('hidden'); }
        function closeManageModal() { document.getElementById('manage-modal').classList.add('hidden'); }
        function saveUserManage() { const u=users.find(x=>x.id==curUid); u.name=document.getElementById('m-name').value; u.target=parseFloat(document.getElementById('m-target').value); u.gender=document.getElementById('m-gender').value; closeManageModal(); sync(); }
        
        window.onload = () => { 
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('view-date').value = today; 
            document.getElementById('log-date').value = today; 
            sync(); 
        };
    </script>
</body>
</html>
